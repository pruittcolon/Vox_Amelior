<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data: https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <title>Nemo Server - Search</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <link rel="stylesheet" href="assets/css/design-tokens.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/animations.css">
  <style>
    .results-note{font-size:.9rem;color:var(--text-tertiary);margin-left:.5rem;font-weight:500}
  </style>
  
  <script>
    window.__ASSET_VERSION__ = '2024110101';
  </script>
  <script src="assets/js/api.js?v=2024110101"></script>
  <script src="assets/js/app.js?v=2024110101"></script>
  <script src="assets/js/auth.js?v=2024110101"></script>
</head>
<body class="gemma-theme">

  <!-- Header -->
  <header class="glass-header">
    <div class="container">
      <div class="flex-between">
        <div class="flex">
          <h1 style="font-size: 1.5rem; margin: 0; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üéôÔ∏è Nemo Server
          </h1>
        </div>
        
        <nav class="nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="search.html" class="nav-link active">Search</a>
          <a href="emotions.html" class="nav-link">Emotions</a>
          <a href="memories.html" class="nav-link">Memories</a>
          <a href="gemma.html" class="nav-link">AI Insights</a>
          <a href="email.html" class="nav-link">Email</a>
          <a href="settings.html" class="nav-link">Settings</a>
        </nav>
        
        <div class="flex" style="gap: 1rem; align-items: center;">
          <span id="current-user" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
          <button id="logout-btn" class="glass-button" style="display: none;" title="Logout">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
          </button>
          <button class="glass-button" data-toggle-theme>
            <i data-lucide="moon" style="width: 18px; height: 18px;"></i>
          </button>
          <div id="api-status"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    
    <!-- Hero -->
    <section class="fade-in-up" style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Search Transcripts</h1>
      <p class="text-muted">Find any conversation, word, or phrase across all your transcriptions</p>
    </section>

    <!-- Search Bar -->
    <section class="fade-in-up delay-100" style="margin-bottom: 3rem;">
      <div class="search-bar" style="margin: 0 auto;">
        <i data-lucide="search" class="search-icon"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search transcripts, speakers, or keywords..."
          id="search-input"
          autofocus
        >
      </div>
    </section>

    <!-- Filters -->
    <section class="fade-in-up delay-200" style="margin-bottom: 2rem;">
      <div style="display: flex; flex-direction: column; gap: 1rem; align-items: center;">
        <div id="filter-chips" style="display: inline-flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
          <span class="chip active" data-filter="all">All Results</span>
          <span class="chip" data-filter="today">Today</span>
          <span class="chip" data-filter="week">This Week</span>
          <span class="chip" data-filter="month">This Month</span>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; justify-content: center;">
          <span class="text-muted" style="font-size: 0.85rem;">Sort by</span>
          <div class="chip-select-wrapper">
            <select id="sort-select" class="chip-select">
              <option value="recent">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="speaker-asc">Speaker A ‚Üí Z</option>
              <option value="speaker-desc">Speaker Z ‚Üí A</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="fade-in-up delay-300">
      <div class="glass-card">
        <h3 id="results-title">Recent Transcripts</h3>
        
        <div id="search-results">
          <!-- Loading -->
          <div id="loading-state">
            <div class="skeleton" style="height: 100px; margin-bottom: 1rem;"></div>
            <div class="skeleton" style="height: 100px; margin-bottom: 1rem;"></div>
            <div class="skeleton" style="height: 100px;"></div>
          </div>
          
          <!-- Empty State -->
          <div id="empty-state" class="hidden" style="text-align: center; padding: 3rem 0;">
            <i data-lucide="search-x" style="width: 64px; height: 64px; color: var(--text-tertiary); margin-bottom: 1rem;"></i>
            <h3>No Results Found</h3>
            <p class="text-muted">Try different keywords or filters</p>
          </div>
          
          <!-- Results Container -->
          <div id="results-container"></div>
        </div>
      </div>
    </section>

  </main>

  <script>
    lucide.createIcons();

    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const resultsContainer = document.getElementById('results-container');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const resultsTitle = document.getElementById('results-title');

    const STOPWORDS = new Set(['the', 'a', 'an', 'of', 'and', 'or', 'to', 'in', 'on', 'at']);

    let currentQuery = '';
    let currentFilter = 'all';
    let currentSort = sortSelect ? sortSelect.value : 'recent';
    let cachedResults = [];

    const debounceFn = (typeof window !== 'undefined' && typeof window.debounce === 'function')
      ? window.debounce
      : (fn, wait = 300) => {
          let timeout;
          return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(null, args), wait);
          };
        };

    const escapeHtmlSafe = (typeof window !== 'undefined' && typeof window.escapeHTML === 'function')
      ? window.escapeHTML
      : (str = '') => String(str ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

    const highlightSafe = (typeof window !== 'undefined' && typeof window.highlightText === 'function')
      ? window.highlightText
      : (text = '', query = '') => {
          if (!query) return escapeHtmlSafe(text);
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const pattern = new RegExp(`(${escaped})`, 'ig');
          return escapeHtmlSafe(text).replace(pattern, '<mark>$1</mark>');
        };

    const showToastSafe = (typeof window !== 'undefined' && typeof window.showToast === 'function')
      ? window.showToast
      : (title, message) => console.warn(`[Toast] ${title}: ${message}`);

    function getDateRange(filter) {
      const today = new Date();
      const start = new Date(today);

      switch (filter) {
        case 'today':
          start.setHours(0, 0, 0, 0);
          return {
            start_date: start.toISOString().split('T')[0],
            end_date: today.toISOString().split('T')[0],
          };
        case 'week':
          start.setDate(today.getDate() - 7);
          return {
            start_date: start.toISOString().split('T')[0],
            end_date: today.toISOString().split('T')[0],
          };
        case 'month':
          start.setDate(today.getDate() - 30);
          return {
            start_date: start.toISOString().split('T')[0],
            end_date: today.toISOString().split('T')[0],
          };
        default:
          return {};
      }
    }

    function buildSearchPayload(query) {
      const payload = {
        query,
        top_k: 30,
        types: ['transcript_segment', 'memory'],
        last_n_transcripts: 100,
      };

      if (currentFilter && currentFilter !== 'all') {
        Object.assign(payload, getDateRange(currentFilter));
      }

      return payload;
    }

    function getEffectiveQuery(raw) {
      const trimmed = (raw || '').trim();
      if (!trimmed) return { effective: '', reason: 'empty' };
      const tokens = trimmed.toLowerCase().split(/\s+/).filter(Boolean);
      const hasMeaningful = tokens.some((token) => !STOPWORDS.has(token));
      return {
        effective: hasMeaningful ? trimmed : '',
        reason: hasMeaningful ? null : 'stopword',
      };
    }

    function formatTimestamp(seconds) {
      if (seconds === null || seconds === undefined) return null;
      const value = Number(seconds);
      if (Number.isNaN(value)) return null;
      const minutes = Math.floor(value / 60);
      const secs = Math.floor(value % 60);
      return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function viewTranscript(jobId, startSeconds) {
      if (!jobId) return;
      const timestamp = typeof startSeconds === 'number' && !Number.isNaN(startSeconds)
        ? `&t=${Math.max(0, Math.floor(startSeconds))}`
        : '';
      window.location.href = `transcripts.html?job=${encodeURIComponent(jobId)}${timestamp}`;
    }
    window.viewTranscript = viewTranscript;

    function sortItems(items) {
      const arr = Array.isArray(items) ? [...items] : [];
      switch (currentSort) {
        case 'speaker-asc':
          return arr.sort((a, b) => (a.speaker || '').localeCompare(b.speaker || '', undefined, { sensitivity: 'base' }));
        case 'speaker-desc':
          return arr.sort((a, b) => (b.speaker || '').localeCompare(a.speaker || '', undefined, { sensitivity: 'base' }));
        case 'oldest':
          return arr.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
        case 'recent':
        default:
          return arr.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      }
    }

    function renderResults(items) {
      resultsContainer.innerHTML = '';

      items.forEach((item, index) => {
        const type = item.type || 'result';
        const speaker = item.speaker || (type === 'memory' ? 'Memory Note' : 'Unknown speaker');
        const title = item.title || speaker || 'Result';
        const segments = Array.isArray(item.segments) ? item.segments : [];
        const snippet = item.snippet || item.text || item.body || '';
        const aggregated = item.full_text || (segments.length ? segments.map(seg => seg.text || '').join(' ') : '');
        const content = aggregated || snippet;
        const score = typeof item.score === 'number' ? item.score : null;
        const emotion = item.emotion || null;
        const emotionConfidence = item.emotion_confidence;
        const timestampLabel = item.timestamp_label || formatTimestamp(item.start_time);
        const createdLabel = item.created_at ? new Date(item.created_at).toLocaleString() : null;
        const jobId = item.job_id || item.transcript_id;
        const startSeconds = item.start_time;

        const resultEl = document.createElement('div');
        resultEl.className = 'card fade-in-up';
        resultEl.style.animationDelay = `${index * 40}ms`;
        resultEl.style.marginBottom = '1rem';

        const avatar = createSpeakerAvatar(speaker || 'Result');
        const emotionBadge = emotion ? createEmotionBadge(emotion, emotionConfidence) : null;

        const metaPieces = [];
        if (timestampLabel) metaPieces.push(`at ${timestampLabel}`);
        if (createdLabel) metaPieces.push(createdLabel);
        const metaLine = metaPieces.join(' ‚Ä¢ ');

        const viewButton = jobId
          ? `<button class="btn btn-ghost btn-sm" onclick="viewTranscript('${jobId}', ${startSeconds ?? 'null'})">View</button>`
          : '';

        const safeSnippet = content
          ? highlightSafe(content, currentQuery)
          : '<span class="text-muted">Transcript text not captured yet.</span>';

        resultEl.innerHTML = `
          <div class="card-header">
            <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
              ${avatar.outerHTML}
              <div style="flex: 1;">
                <div style="font-weight: 600;">${escapeHtmlSafe(title)}</div>
                <div class="text-muted" style="font-size: 0.75rem;">
                  ${escapeHtmlSafe(speaker || '')}${metaLine ? ` ‚Ä¢ ${escapeHtmlSafe(metaLine)}` : ''}
                </div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              ${emotionBadge ? emotionBadge.outerHTML : ''}
              ${score ? `<span class="badge" style="background: var(--accent-color); color: white;">${(score * 100).toFixed(0)}%</span>` : ''}
            </div>
          </div>
          <div class="card-body" style="background: rgba(15,23,42,.55); border-radius: 0.85rem; padding: 1rem;">
            ${safeSnippet}
          </div>
          <div class="card-footer">
            <span class="text-muted" style="font-size: 0.8rem; text-transform: capitalize;">${escapeHtmlSafe(type.replace('_', ' '))}</span>
            <div style="display: flex; gap: 0.5rem;">
              ${viewButton}
            </div>
          </div>
        `;

        resultsContainer.appendChild(resultEl);
      });

      lucide.createIcons();
    }

    function displayResults(items, { cache = true } = {}) {
      if (cache) {
        cachedResults = Array.isArray(items) ? [...items] : [];
      }
      const ordered = sortItems(cache ? cachedResults : items);
      if (!ordered.length) {
        emptyState.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        return;
      }
      emptyState.classList.add('hidden');
      renderResults(ordered);
    }

    const performSearch = debounceFn(async () => {
      const query = searchInput.value.trim();
      currentQuery = query;
      const { effective, reason } = getEffectiveQuery(query);
      const payload = buildSearchPayload(effective);
      const forcingRecent = !effective;

      loadingState.classList.remove('hidden');
      resultsContainer.innerHTML = '';
      emptyState.classList.add('hidden');

      try {
        const unifiedResult = await api.searchUnified(payload);
        const items = unifiedResult?.items || [];

        loadingState.classList.add('hidden');

        if (!items.length) {
          emptyState.classList.remove('hidden');
          resultsTitle.textContent = query ? `Search Results for "${query}"` : 'Recent Transcripts';
          return;
        }

        if (unifiedResult?.fallback || forcingRecent) {
          if (query && reason === 'stopword') {
            resultsTitle.innerHTML = `Recent Transcripts <span class="results-note">("${escapeHtmlSafe(query)}" is too common)</span>`;
          } else if (query) {
            resultsTitle.innerHTML = `Recent Transcripts <span class="results-note">(showing freshest matches)</span>`;
          } else {
            resultsTitle.textContent = 'Recent Transcripts';
          }
        } else if (query) {
          resultsTitle.textContent = `Search Results for "${query}"`;
        } else {
          resultsTitle.textContent = 'Recent Transcripts';
        }

        displayResults(items);
      } catch (error) {
        console.error('Search failed:', error);
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        showToastSafe('Error', 'Search failed', 'error');
      }
    }, 450);

    if (sortSelect) {
      sortSelect.addEventListener('change', () => {
        currentSort = sortSelect.value;
        displayResults(cachedResults, { cache: false });
      });
    }

    document.querySelectorAll('[data-filter]').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('[data-filter]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        performSearch();
      });
    });

    searchInput.addEventListener('input', performSearch);

    async function initPage() {
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;
      performSearch();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>

</body>
</html>
