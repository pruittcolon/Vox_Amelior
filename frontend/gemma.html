<!DOCTYPE html>
<html lang="en">

<head>
    <script src="assets/js/remote-config.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data: https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>AI Assistant - Vox Amelior</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <script src="assets/js/vendor/lucide.min.js"></script>
  <script src="assets/js/vendor/chart.umd.min.js"></script>

  <link rel="stylesheet" href="assets/css/main.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/design-tokens.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/components.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/animations.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/analyzer.css?v=2024110802">


  <!-- Vox Amelior Design System -->
  <link rel="stylesheet" href="assets/css/vox-amelior.css">

  <!-- Page-specific styles -->
  <link rel="stylesheet" href="assets/css/pages/gemma.css">

  <!-- Emotion styles (for Emotions tab) -->
  <link rel="stylesheet" href="assets/css/pages/emotions.css">

  <script>
    window.__ASSET_VERSION__ = '2024110802';
  </script>
  <script src="assets/js/api.js?v=2024110101"></script>
  <script src="assets/js/app.js?v=2024110101"></script>
  <script src="assets/js/auth.js?v=2024110101"></script>
  <script src="assets/js/gemma_analyzer_ui.js?v=2024110802"></script>

  <!-- Chart.js for Emotions tab -->

</head>


<body class="gemma-theme">

  <!-- Navigation (Vox Amelior) -->
  <nav class="vox-nav">
    <div class="vox-nav-inner">
      <a href="index.html" class="vox-logo">
        <div class="vox-logo-mark">
          <img src="assets/images/logo.png" alt="Vox Amelior Logo">
        </div>
        <span class="vox-logo-text">Vox Amelior</span>
      </a>

      <div class="vox-nav-links">
        <a href="index.html" class="vox-nav-link">Dashboard</a>
        <a href="gemma.html" class="vox-nav-link active">AI Assistant</a>
        <a href="nexus.html" class="vox-nav-link">Analytics</a>
        <a href="banking.html" class="vox-nav-link">Enterprise</a>
        <a href="settings.html" class="vox-nav-link">Settings</a>
      </div>

      <div style="display: flex; gap: 0.75rem; align-items: center;">
        <span id="current-user" style="color: var(--vox-grey-500); font-size: 0.9rem;"></span>
        <div id="api-status"></div>
        <a href="login.html" class="vox-btn vox-btn-ghost">Sign Out</a>
      </div>
    </div>
  </nav>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    <div class="gemma-shell">

      <section class="fade-in-up" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Gemma AI Insights</h1>
        <p class="text-muted">GPU-accelerated analysis with personality detection & summarization</p>
      </section>

      <!-- Stats -->
      <section class="grid grid-3 fade-in-up delay-100 gemma-hero-stats" style="margin-bottom: 2rem;">
        <div class="stat-card">
          <i data-lucide="cpu" style="width: 28px; height: 28px; color: var(--primary); margin-bottom: 0.5rem;"></i>
          <div class="stat-value">Gemma 3 4B</div>
          <div class="stat-label">AI Model (Q4_K_M)</div>
        </div>

        <div class="stat-card">
          <i data-lucide="zap" style="width: 28px; height: 28px; color: var(--success); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="gpu-memory">~4GB</div>
          <div class="stat-label">GPU VRAM Usage</div>
        </div>

        <div class="stat-card">
          <i data-lucide="activity"
            style="width: 28px; height: 28px; color: var(--warning); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="inference-speed">~30 tok/s</div>
          <div class="stat-label">Inference Speed</div>
        </div>
      </section>

      <!-- Tabbed Interface -->
      <section class="fade-in-up delay-100" style="margin-bottom: 1.5rem;">
        <div class="gemma-tabs">
          <button class="gemma-tab active" data-tab="chat">
            <i data-lucide="message-circle" style="width: 18px; height: 18px;"></i>
            Chat
          </button>
          <button class="gemma-tab" data-tab="transcripts">
            <i data-lucide="file-text" style="width: 18px; height: 18px;"></i>
            Transcriptions
          </button>
          <button class="gemma-tab" data-tab="emotions">
            <i data-lucide="smile" style="width: 18px; height: 18px;"></i>
            Emotions
          </button>
          <button class="gemma-tab" data-tab="search">
            <i data-lucide="search" style="width: 18px; height: 18px;"></i>
            Search
          </button>
          <button class="gemma-tab" data-tab="databases">
            <i data-lucide="database" style="width: 18px; height: 18px;"></i>
            Databases
          </button>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- Tab Content: Analytics                       -->
      <!-- ============================================ -->
      <div id="tab-analytics" class="gemma-tab-content" style="display:none;">

        <section class="gemma-period-filter fade-in-up delay-150">
          <div class="chip-group chip-group-center" id="gemma-period-chips">
            <button type="button" class="chip-toggle" data-gemma-period="today">Today</button>
            <button type="button" class="chip-toggle" data-gemma-period="week">This Week</button>
            <button type="button" class="chip-toggle" data-gemma-period="month">This Month</button>
            <button type="button" class="chip-toggle" data-gemma-period="all">All Time</button>
          </div>
        </section>

        <section class="gemma-stat-grid fade-in-up delay-200" id="gemma-stat-grid">
          <div class="gemma-stat-card" style="--stat-accent:var(--emotion-joy);">
            <div class="stat-icon">
              <i data-lucide="smile" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-joy-count">0</div>
            <div class="stat-label">Joy Detected</div>
            <div class="stat-hint">Updated from analytics</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:var(--emotion-anger);">
            <div class="stat-icon">
              <i data-lucide="frown" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-negative-count">0</div>
            <div class="stat-label">Negative Signals</div>
            <div class="stat-hint">Anger ‚Ä¢ Fear ‚Ä¢ Sadness ‚Ä¢ Disgust</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#7c3aed;">
            <div class="stat-icon">
              <i data-lucide="activity" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-total-analyzed">0</div>
            <div class="stat-label">Total Segments</div>
            <div class="stat-hint" id="gemma-period-label">Selected range</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#38bdf8;">
            <div class="stat-icon">
              <i data-lucide="wind" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-avg-pace">0</div>
            <div class="stat-label">Avg Pace (WPM)</div>
            <div class="stat-hint">Speech overlay</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#fbbf24;">
            <div class="stat-icon">
              <i data-lucide="audio-lines" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-avg-pitch">0</div>
            <div class="stat-label">Avg Pitch (Hz)</div>
            <div class="stat-hint">Speech overlay</div>
          </div>
        </section>

        <section class="glass-card gemma-filter-panel fade-in-up delay-250">
          <div class="gemma-filter-grid">
            <div class="gemma-filter-column">
              <div class="chip-panel-header">
                <h4>Emotion Layers</h4>
                <button type="button" class="chip-toggle chip-all" id="gemma-emotion-all">All</button>
              </div>
              <div class="chip-group" id="gemma-emotion-chips"></div>
            </div>
            <div class="gemma-filter-column">
              <div class="chip-panel-header">
                <h4>Speech Overlays</h4>
                <button type="button" class="chip-toggle chip-all" id="gemma-metric-all">All</button>
              </div>
              <div class="chip-group" id="gemma-metric-chips"></div>
            </div>
          </div>
          <div class="gemma-confidence-control">
            <div class="chip-panel-header">
              <h4>Emotion Confidence Baseline</h4>
              <span id="gemma-confidence-label">70%</span>
            </div>
            <div class="gemma-confidence-slider">
              <input type="range" min="50" max="100" step="5" value="70" id="gemma-confidence-range">
            </div>
            <p class="gemma-confidence-hint">Used whenever transcripts do not include explicit emotion confidence
              scores.
            </p>
          </div>
        </section>

        <!-- Chat Interface removed; use analyzer chat drawer (bottom/overlay) to avoid cramped layout. -->

        <!-- Advanced Analysis Section -->
        <section class="fade-in-up delay-300" style="margin-top: 2rem;">
          <div class="glass-card">
            <div
              style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; cursor: pointer;"
              onclick="toggleAdvancedAnalysis()">
              <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                <i data-lucide="brain" style="width: 24px; height: 24px; color: var(--primary);"></i>
                Advanced Conversation Analysis
              </h3>
              <i data-lucide="chevron-down" id="analysis-toggle-icon"
                style="width: 20px; height: 20px; transition: transform 0.3s;"></i>
            </div>

            <div id="advanced-analysis-content" style="display: block;">
              <p class="text-muted" style="margin-bottom: 1.5rem;">
                Analyze conversations for patterns, fallacies, emotional triggers. Customize the analysis prompt and
                filters.
              </p>
              <div id="gemma-advanced-analyzer"></div>
            </div>
          </div>
      </div>
      </section>

      <!-- Quick Actions -->
      <section class="grid grid-2 fade-in-up delay-300 gemma-quick-actions" style="margin-top: 2rem;">
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Quick Actions</h4>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-ghost" onclick="quickAnalysis('summary')">
              <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
              Generate Summary
            </button>
            <button class="btn btn-ghost" onclick="quickAnalysis('personality')">
              <i data-lucide="user" style="width: 16px; height: 16px;"></i>
              Analyze Personality
            </button>
            <button class="btn btn-ghost" onclick="quickAnalysis('patterns')">
              <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
              Find Patterns
            </button>
          </div>
        </div>

        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Example Questions</h4>
          <div style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.8;">
            ‚Ä¢ "What were the main topics discussed today?"<br>
            ‚Ä¢ "Analyze the personality of Speaker 1"<br>
            ‚Ä¢ "What emotions dominated this week?"<br>
            ‚Ä¢ "Summarize the last conversation"
          </div>
        </div>
      </section>

    </div><!-- End Analytics Tab -->

    <!-- ============================================ -->
    <!-- Tab Content: Chat                            -->
    <!-- ============================================ -->
    <div id="tab-chat" class="gemma-tab-content active">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="message-circle" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Chat with Gemma
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Ask questions about your transcripts, get summaries, or have a conversation with the AI.
        </p>

        <div class="chat-interface">
          <!-- Active Database Indicator -->
          <div id="active-db-indicator" class="active-db-indicator" style="display: none;">
            <i data-lucide="database" style="width: 16px; height: 16px; color: var(--primary);"></i>
            <span class="db-name">No database selected</span>
            <span class="db-badge">RAG Mode</span>
            <button class="btn-clear-db" onclick="clearActiveDatabase()" title="Clear database">√ó</button>
          </div>
          <div class="chat-messages-area" id="chat-messages">
            <div class="chat-message-row">
              <div class="chat-avatar-icon ai-avatar">
                <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
              </div>
              <div class="chat-bubble-content ai-bubble">
                Hello! I'm Gemma, your AI assistant. I can help you analyze conversations, summarize transcripts, detect
                emotions, and answer questions about your data. What would you like to know?
              </div>
            </div>
          </div>

          <div class="chat-input-row">
            <input type="text" id="chat-input" class="glass-input" placeholder="Type your message..." style="flex: 1;">
            <button class="btn btn-primary" onclick="sendChatMessage()">
              <i data-lucide="send" style="width: 18px; height: 18px;"></i>
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Prompts -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Quick Prompts</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <button class="chip-toggle" onclick="useQuickPrompt('Summarize my conversations from today')">üìù Today's
            Summary</button>
          <button class="chip-toggle" onclick="useQuickPrompt('What emotions were most common this week?')">üòä Emotion
            Analysis</button>
          <button class="chip-toggle" onclick="useQuickPrompt('What topics come up most frequently?')">üîç Topic
            Trends</button>
          <button class="chip-toggle" onclick="useQuickPrompt('Analyze the personality traits in my conversations')">üë§
            Personality</button>
        </div>
      </div>
    </div><!-- End Chat Tab -->

    <!-- ============================================ -->
    <!-- Tab Content: Transcriptions                  -->
    <!-- ============================================ -->
    <div id="tab-transcripts" class="gemma-tab-content">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="file-text" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Transcription Analysis
        </h3>
        <p class="text-muted" style="margin-bottom: 1rem;">
          Browse transcripts with emotion filtering and AI-powered insights.
        </p>

        <!-- Emotion Filter Chips -->
        <div class="chip-toolbar" style="margin-bottom: 1rem;">
          <div class="chip-group" id="transcript-emotion-filters">
            <button type="button" class="chip-toggle chip-all active" data-emotion="all"
              onclick="filterTranscriptsByEmotion('all')">All</button>
            <button type="button" class="chip-toggle" data-emotion="joy" onclick="filterTranscriptsByEmotion('joy')"
              style="border-color: #10b981;">üòä Joy</button>
            <button type="button" class="chip-toggle" data-emotion="anger" onclick="filterTranscriptsByEmotion('anger')"
              style="border-color: #ef4444;">üò† Anger</button>
            <button type="button" class="chip-toggle" data-emotion="sadness"
              onclick="filterTranscriptsByEmotion('sadness')" style="border-color: #3b82f6;">üò¢ Sadness</button>
            <button type="button" class="chip-toggle" data-emotion="fear" onclick="filterTranscriptsByEmotion('fear')"
              style="border-color: #8b5cf6;">üò∞ Fear</button>
            <button type="button" class="chip-toggle" data-emotion="neutral"
              onclick="filterTranscriptsByEmotion('neutral')" style="border-color: #6b7280;">üòê Neutral</button>
          </div>
        </div>

        <!-- Transcript Navigation -->
        <div class="transcript-nav" id="transcript-nav" style="display: none;">
          <button class="transcript-nav-btn" onclick="navigateTranscript('prev')" id="prev-transcript-btn" disabled>
            <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i> Previous
          </button>
          <span id="transcript-position">1 of 1</span>
          <button class="transcript-nav-btn" onclick="navigateTranscript('next')" id="next-transcript-btn" disabled>
            Next <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
          </button>
          <button class="transcript-nav-btn" onclick="returnToTranscriptList()" style="margin-left: auto;">
            <i data-lucide="list" style="width: 16px; height: 16px;"></i> Back to List
          </button>
        </div>

        <!-- Transcript Content -->
        <div id="transcript-content">
          <div id="transcript-list" class="transcript-list">
            <div class="skeleton" style="height: 60px; margin-bottom: 0.5rem;"></div>
            <div class="skeleton" style="height: 60px; margin-bottom: 0.5rem;"></div>
            <div class="skeleton" style="height: 60px;"></div>
          </div>
          <div id="transcript-viewer" class="transcript-viewer"
            style="display: none; max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>

      <!-- Summary & Insights Panel -->
      <div class="glass-card" style="margin-top: 1.5rem;" id="transcript-insights-panel" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <h4 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="sparkles" style="width: 20px; height: 20px; color: var(--primary);"></i>
            Summary & Insights
          </h4>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-ghost btn-sm" onclick="generateTranscriptSummary()" id="generate-summary-btn">
              <i data-lucide="wand-2" style="width: 14px; height: 14px;"></i>
              Generate Summary
            </button>
            <button class="btn btn-primary btn-sm" onclick="saveTranscriptNotes()" id="save-notes-btn">
              <i data-lucide="save" style="width: 14px; height: 14px;"></i>
              Save
            </button>
          </div>
        </div>

        <!-- User Notes -->
        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
            Your Notes (saved per transcript)
          </label>
          <textarea id="transcript-notes" class="glass-input" rows="3"
            placeholder="Add your notes about this transcript..." style="width: 100%; resize: vertical;"></textarea>
        </div>

        <!-- AI-Generated Insights -->
        <div id="ai-insights" style="display: none;">
          <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
            AI-Generated Summary
          </label>
          <div id="ai-insights-content"
            style="background: rgba(0, 82, 204, 0.03); border-radius: 0.75rem; padding: 1rem; line-height: 1.6;">
            <!-- AI insights will appear here -->
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="stat-grid" style="margin-top: 1rem;" id="transcript-metrics">
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-segments" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Segments</div>
          </div>
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-speakers" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Speakers</div>
          </div>
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-duration" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Duration</div>
          </div>
          <div class="stat-card hover-lift" style="padding: 0.75rem;">
            <div class="stat-value" id="metric-emotion" style="font-size: 1.5rem;">-</div>
            <div class="stat-label" style="font-size: 0.75rem;">Dominant</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Tab Content: Emotions                        -->
    <!-- ============================================ -->
    <div id="tab-emotions" class="gemma-tab-content" data-emotions-container>

      <!-- Period Filter -->
      <div class="chip-toolbar" style="margin-bottom: 1.5rem;">
        <div class="chip-group" id="emotions-period-chips">
          <button type="button" class="chip-toggle active" data-period="today"
            onclick="filterEmotionsPeriod('today')">Today</button>
          <button type="button" class="chip-toggle" data-period="week" onclick="filterEmotionsPeriod('week')">This
            Week</button>
          <button type="button" class="chip-toggle" data-period="month" onclick="filterEmotionsPeriod('month')">This
            Month</button>
          <button type="button" class="chip-toggle" data-period="all" onclick="filterEmotionsPeriod('all')">All
            Time</button>
        </div>
      </div>

      <!-- Top Row: Radar + Speaker Insights -->
      <section class="grid grid-2" style="margin-bottom: 1.5rem; gap: 1.5rem;">
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Speech Pattern Radar</h4>
          <div style="height: 220px;">
            <canvas id="speech-radar-chart"></canvas>
          </div>
        </div>
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Speaker Insights</h4>
          <div style="max-height: 220px; overflow-y: auto;">
            <table style="width: 100%; font-size: 0.85rem;">
              <thead>
                <tr style="text-align: left; color: var(--text-secondary);">
                  <th style="padding: 0.5rem;">Speaker</th>
                  <th>Segments</th>
                  <th>Emotion</th>
                  <th>Pace</th>
                  <th>Pitch</th>
                </tr>
              </thead>
              <tbody id="speaker-table-body">
                <tr>
                  <td colspan="5" class="text-muted">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Stat Cards -->
      <section class="stat-grid" style="margin-bottom: 1.5rem;">
        <div class="stat-card hover-lift">
          <i data-lucide="smile" style="width: 28px; height: 28px; color: var(--success); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-joy">0</div>
          <div class="stat-label">Joy Detected</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="frown" style="width: 28px; height: 28px; color: var(--danger); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-negative">0</div>
          <div class="stat-label">Negative</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="activity"
            style="width: 28px; height: 28px; color: var(--primary); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Analyzed</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="gauge" style="width: 28px; height: 28px; color: #3b82f6; margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-pace">-</div>
          <div class="stat-label">Avg Pace</div>
        </div>
        <div class="stat-card hover-lift">
          <i data-lucide="audio-lines" style="width: 28px; height: 28px; color: #f59e0b; margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="stat-pitch">-</div>
          <div class="stat-label">Avg Pitch</div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid grid-2" style="gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Emotion Distribution</h4>
          <div style="height: 250px;">
            <canvas id="emotion-distribution-chart"></canvas>
          </div>
        </div>
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Emotion Timeline</h4>
          <div style="height: 250px;">
            <canvas id="emotion-trend-chart"></canvas>
          </div>
        </div>
      </section>

      <!-- Emotional Moments Feed -->
      <section class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0;">Recent Emotional Moments</h4>
          <div class="chip-group" id="moment-emotion-filter">
            <button type="button" class="chip-toggle chip-all active" data-emotion="all"
              onclick="filterMomentEmotion('all')">All</button>
            <button type="button" class="chip-toggle" data-emotion="joy"
              onclick="filterMomentEmotion('joy')">üòä</button>
            <button type="button" class="chip-toggle" data-emotion="anger"
              onclick="filterMomentEmotion('anger')">üò†</button>
            <button type="button" class="chip-toggle" data-emotion="sadness"
              onclick="filterMomentEmotion('sadness')">üò¢</button>
          </div>
        </div>
        <div id="emotion-moment-feed" style="max-height: 400px; overflow-y: auto;">
          <div class="skeleton" style="height: 80px; margin-bottom: 1rem;"></div>
          <div class="skeleton" style="height: 80px; margin-bottom: 1rem;"></div>
          <div class="skeleton" style="height: 80px;"></div>
        </div>
      </section>

      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="emotions.html" class="vox-btn vox-btn-ghost">Open Full Emotions Dashboard ‚Üí</a>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Tab Content: Search                          -->
    <!-- ============================================ -->
    <div id="tab-search" class="gemma-tab-content">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="search" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Semantic Search
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Search across all your transcripts using natural language.
        </p>

        <div class="search-container">
          <div class="search-input-wrapper">
            <i data-lucide="search" class="search-icon" style="width: 20px; height: 20px;"></i>
            <input type="text" id="semantic-search-input" placeholder="Search transcripts..."
              onkeypress="if(event.key==='Enter') performSemanticSearch()">
          </div>

          <div id="search-results" class="search-results">
            <p class="text-muted" style="text-align: center; padding: 2rem;">
              Enter a search query to find relevant segments in your transcripts.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- Tab Content: Databases                       -->
    <!-- ============================================ -->
    <div id="tab-databases" class="gemma-tab-content">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="database" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Custom Database Upload
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Upload CSV files to add custom data for AI analysis. The data will be vectorized and available for RAG
          queries.
        </p>

        <div class="db-upload-zone" id="db-upload-zone" onclick="document.getElementById('db-file-input').click()">
          <i data-lucide="upload-cloud" class="db-upload-icon"></i>
          <h4>Drop CSV files here or click to upload</h4>
          <p class="text-muted" style="margin-top: 0.5rem;">Supports CSV format ‚Ä¢ Max 50MB per file</p>
          <input type="file" id="db-file-input" accept=".csv" multiple style="display: none;"
            onchange="handleDatabaseUpload(event)">
        </div>

        <div class="db-file-list" id="db-file-list">
          <!-- Files will be listed here -->
        </div>
      </div>

      <!-- Existing Databases -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="folder-open" style="width: 20px; height: 20px;"></i>
          Uploaded Databases
        </h4>
        <div id="existing-databases">
          <p class="text-muted">No custom databases uploaded yet.</p>
        </div>
      </div>

      <!-- Database Info -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Supported Formats</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <strong>CSV Requirements:</strong>
            <ul style="color: var(--text-secondary); font-size: 0.875rem; padding-left: 1.2rem; margin-top: 0.5rem;">
              <li>UTF-8 encoding</li>
              <li>Header row required</li>
              <li>Comma separated</li>
            </ul>
          </div>
          <div>
            <strong>Coming Soon:</strong>
            <ul style="color: var(--text-muted); font-size: 0.875rem; padding-left: 1.2rem; margin-top: 0.5rem;">
              <li>JSON support</li>
              <li>Excel (.xlsx)</li>
              <li>Parquet files</li>
            </ul>
          </div>
        </div>
      </div>
    </div><!-- End Databases Tab -->

    </div><!-- End gemma-shell -->
  </main>

  <script>
    lucide.createIcons();

    const GEMMA_EMOTION_OPTIONS = [
      { key: 'anger', label: 'Anger', color: 'var(--emotion-anger)' },
      { key: 'fear', label: 'Fear', color: 'var(--emotion-fear)' },
      { key: 'joy', label: 'Joy', color: 'var(--emotion-joy)' },
      { key: 'neutral', label: 'Neutral', color: 'var(--emotion-neutral)' },
      { key: 'sadness', label: 'Sadness', color: 'var(--emotion-sadness)' },
      { key: 'surprise', label: 'Surprise', color: 'var(--emotion-surprise)' },
      { key: 'disgust', label: 'Disgust', color: 'var(--emotion-disgust)' },
    ];

    const GEMMA_METRIC_OPTIONS = [
      { key: 'pace_wpm', label: 'Pace', color: '#38bdf8' },
      { key: 'pitch_mean', label: 'Pitch', color: '#fbbf24' },
      { key: 'volume_rms', label: 'Volume', color: '#f472b6' },
      { key: 'volume_peak', label: 'Volume Peak', color: '#fb7185' },
      { key: 'pause_ms', label: 'Pauses', color: '#14b8a6' },
      { key: 'word_count', label: 'Words', color: '#facc15' },
    ];

    const GEMMA_PERIOD_LOOKBACK = { today: 0, week: 6, month: 29, all: null };
    const GEMMA_PERIOD_LABELS = { today: 'Today', week: 'This Week', month: 'This Month', all: 'All Time' };

    const gemmaInsightsState = {
      period: 'all',
      selectedEmotions: new Set(GEMMA_EMOTION_OPTIONS.map((opt) => opt.key)),
      selectedMetrics: new Set(GEMMA_METRIC_OPTIONS.map((opt) => opt.key)),
      analytics: null,
      loading: false,
    };

    // ================================================
    // Database State Management (RAG Chatbot)
    // ================================================
    let activeDatabase = null;  // {filename, displayName, columns, isReady}

    function setActiveDatabase(db) {
      activeDatabase = db;

      // Persist to localStorage for session persistence
      if (db) {
        localStorage.setItem('nemo_active_database', JSON.stringify({
          filename: db.filename,
          displayName: db.displayName,
          columns: db.columns || [],
          isReady: db.isReady
        }));
      } else {
        localStorage.removeItem('nemo_active_database');
      }

      updateDatabaseIndicator();
    }

    function clearActiveDatabase() {
      setActiveDatabase(null);
      addChatMessage('üìä Database cleared. I\'ll respond with general knowledge now.', 'ai');
    }

    function updateDatabaseIndicator() {
      const indicator = document.getElementById('active-db-indicator');
      if (!indicator) return;

      if (activeDatabase && activeDatabase.isReady) {
        indicator.style.display = 'flex';
        indicator.querySelector('.db-name').textContent = activeDatabase.displayName;
        lucide.createIcons();
      } else {
        indicator.style.display = 'none';
      }

      // Also refresh the databases list to show active state
      loadSavedDatabases();
    }

    async function restoreActiveDatabase() {
      const saved = localStorage.getItem('nemo_active_database');
      if (saved) {
        try {
          const db = JSON.parse(saved);

          // Verify the database still exists on server
          const response = await fetch('/databases', { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            const exists = data.databases.find(d => d.filename === db.filename);

            if (exists && exists.has_embeddings) {
              activeDatabase = { ...db, isReady: true };
              updateDatabaseIndicator();
              return;
            }
          }
        } catch (e) {
          console.warn('Could not restore database session:', e);
        }

        // Clear invalid saved state
        localStorage.removeItem('nemo_active_database');
      }
    }

    const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    const GEMMA_DEFAULT_CONFIDENCE = getDefaultConfidencePercent();
    let gemmaConfidencePercent = GEMMA_DEFAULT_CONFIDENCE;
    let gemmaConfidenceSlider;
    let gemmaConfidenceLabel;

    function getDefaultConfidencePercent() {
      try {
        if (typeof window !== 'undefined' && typeof window.getEmotionConfidenceBaseline === 'function') {
          return Math.round(window.getEmotionConfidenceBaseline() * 100);
        }
      } catch (_) {
        /* noop */
      }
      return 70;
    }

    function initGemmaControls() {
      renderGemmaEmotionChips();
      renderGemmaMetricChips();
      bindGemmaPeriodChips();
      const emotionAllBtn = document.getElementById('gemma-emotion-all');
      if (emotionAllBtn) {
        emotionAllBtn.onclick = () => {
          gemmaInsightsState.selectedEmotions = new Set(GEMMA_EMOTION_OPTIONS.map((opt) => opt.key));
          renderGemmaEmotionChips();
          syncAnalyzerEmotionsFromState();
          refreshGemmaAnalytics();
        };
      }
      const metricAllBtn = document.getElementById('gemma-metric-all');
      if (metricAllBtn) {
        metricAllBtn.onclick = () => {
          gemmaInsightsState.selectedMetrics = new Set(GEMMA_METRIC_OPTIONS.map((opt) => opt.key));
          renderGemmaMetricChips();
          refreshGemmaAnalytics();
        };
      }
      initGemmaConfidenceControl();
      syncAnalyzerEmotionsFromState();
      return setGemmaPeriod('all', { force: true });
    }

    function renderGemmaEmotionChips() {
      const container = document.getElementById('gemma-emotion-chips');
      if (!container) return;
      container.innerHTML = GEMMA_EMOTION_OPTIONS.map((opt) => {
        const active = gemmaInsightsState.selectedEmotions.has(opt.key);
        return `
          <button type="button" class="chip-toggle" data-emotion="${opt.key}" aria-pressed="${active}" style="--chip-color:${opt.color};">
            ${opt.label}
          </button>
        `;
      }).join('');
      container.querySelectorAll('button[data-emotion]').forEach((btn) => {
        btn.addEventListener('click', () => toggleGemmaEmotion(btn.dataset.emotion));
      });
    }

    function renderGemmaMetricChips() {
      const container = document.getElementById('gemma-metric-chips');
      if (!container) return;
      container.innerHTML = GEMMA_METRIC_OPTIONS.map((opt) => {
        const active = gemmaInsightsState.selectedMetrics.has(opt.key);
        return `
          <button type="button" class="chip-toggle" data-metric="${opt.key}" aria-pressed="${active}" style="--chip-color:${opt.color};">
            ${opt.label}
          </button>
        `;
      }).join('');
      container.querySelectorAll('button[data-metric]').forEach((btn) => {
        btn.addEventListener('click', () => toggleGemmaMetric(btn.dataset.metric));
      });
    }

    function initGemmaConfidenceControl() {
      gemmaConfidenceSlider = document.getElementById('gemma-confidence-range');
      gemmaConfidenceLabel = document.getElementById('gemma-confidence-label');
      if (!gemmaConfidenceSlider || !gemmaConfidenceLabel) return;
      gemmaConfidenceSlider.value = gemmaConfidencePercent;
      gemmaConfidenceLabel.textContent = `${gemmaConfidencePercent}%`;
      gemmaConfidenceSlider.addEventListener('input', (event) => {
        gemmaConfidencePercent = Number(event.target.value);
        gemmaConfidenceLabel.textContent = `${gemmaConfidencePercent}%`;
        syncAnalyzerConfidence(gemmaConfidencePercent);
      });
      syncAnalyzerConfidence(gemmaConfidencePercent);
    }

    function syncAnalyzerEmotionsFromState() {
      if (typeof window === 'undefined' || typeof window.dispatchEvent !== 'function') return;
      const payload = Array.from(gemmaInsightsState.selectedEmotions || []);
      window.dispatchEvent(new CustomEvent('gemmaEmotionFiltersChanged', { detail: payload }));
    }

    function toggleGemmaEmotion(emotion) {
      if (!emotion) return;
      const set = gemmaInsightsState.selectedEmotions;
      if (set.has(emotion)) {
        set.delete(emotion);
      } else {
        set.add(emotion);
      }
      if (!set.size) {
        GEMMA_EMOTION_OPTIONS.forEach((opt) => set.add(opt.key));
      }
      renderGemmaEmotionChips();
      syncAnalyzerEmotionsFromState();
      refreshGemmaAnalytics();
    }

    function toggleGemmaMetric(metric) {
      if (!metric) return;
      const set = gemmaInsightsState.selectedMetrics;
      if (set.has(metric)) {
        set.delete(metric);
      } else {
        set.add(metric);
      }
      if (!set.size) {
        GEMMA_METRIC_OPTIONS.forEach((opt) => set.add(opt.key));
      }
      renderGemmaMetricChips();
      refreshGemmaAnalytics();
    }

    function bindGemmaPeriodChips() {
      document.querySelectorAll('[data-gemma-period]').forEach((btn) => {
        btn.addEventListener('click', () => setGemmaPeriod(btn.dataset.gemmaPeriod));
      });
    }

    function setGemmaPeriod(period, { force = false } = {}) {
      if (!period) return;
      if (!force && gemmaInsightsState.period === period) return;
      gemmaInsightsState.period = period;
      document.querySelectorAll('[data-gemma-period]').forEach((btn) => {
        const isActive = btn.dataset.gemmaPeriod === period;
        btn.setAttribute('aria-pressed', isActive);
        btn.classList.toggle('active', isActive);
      });
      return refreshGemmaAnalytics();
    }

    function setGemmaInsightsLoading(isLoading) {
      const grid = document.getElementById('gemma-stat-grid');
      gemmaInsightsState.loading = isLoading;
      if (grid) grid.classList.toggle('loading', !!isLoading);
    }

    function computeGemmaPeriodRange(period) {
      if (period === 'all') {
        return { start: null, end: null };
      }
      const lookback = GEMMA_PERIOD_LOOKBACK[period] ?? 6;
      const now = new Date();
      const end = now.toISOString().slice(0, 10);
      const startDate = new Date(now);
      startDate.setDate(startDate.getDate() - lookback);
      const start = startDate.toISOString().slice(0, 10);
      return { start, end };
    }

    async function refreshGemmaAnalytics() {
      setGemmaInsightsLoading(true);
      const { start, end } = computeGemmaPeriodRange(gemmaInsightsState.period);
      try {
        const payload = await api.getAnalyticsSignals({
          start_date: start || undefined,
          end_date: end || undefined,
          emotions: Array.from(gemmaInsightsState.selectedEmotions),
          metrics: Array.from(gemmaInsightsState.selectedMetrics),
        });
        gemmaInsightsState.analytics = payload;
        renderGemmaStatCards(payload?.summary || {});
      } catch (error) {
        console.error('[Gemma] Failed to load analytics signals', error);
        renderGemmaStatCards(null);
      } finally {
        setGemmaInsightsLoading(false);
      }
    }

    function renderGemmaStatCards(summary) {
      if (!summary) {
        setTextContent('gemma-joy-count', '‚Äî');
        setTextContent('gemma-negative-count', '‚Äî');
        setTextContent('gemma-total-analyzed', '‚Äî');
        setTextContent('gemma-avg-pace', '‚Äî');
        setTextContent('gemma-avg-pitch', '‚Äî');
        const label = document.getElementById('gemma-period-label');
        if (label) {
          const name = GEMMA_PERIOD_LABELS[gemmaInsightsState.period] || 'Selected';
          label.textContent = `${name} window`;
        }
        return;
      }
      const totals = summary?.emotion_totals || {};
      const joy = totals.joy ?? 0;
      const negative = (totals.anger || 0) + (totals.fear || 0) + (totals.sadness || 0) + (totals.disgust || 0);
      const totalAnalyzed = summary?.total_analyzed ?? 0;
      const avgPace = summary?.avg_pace_wpm ?? null;
      const avgPitch = summary?.avg_pitch_mean ?? null;

      setTextContent('gemma-joy-count', formatBigNumber(joy));
      setTextContent('gemma-negative-count', formatBigNumber(negative));
      setTextContent('gemma-total-analyzed', formatBigNumber(totalAnalyzed));
      setTextContent('gemma-avg-pace', formatMetricValue(avgPace));
      setTextContent('gemma-avg-pitch', formatMetricValue(avgPitch));

      const label = document.getElementById('gemma-period-label');
      if (label) {
        const name = GEMMA_PERIOD_LABELS[gemmaInsightsState.period] || 'Selected';
        label.textContent = `${name} window`;
      }
    }

    function setTextContent(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatBigNumber(value) {
      if (value === null || value === undefined) return '‚Äî';
      const num = Number(value);
      if (!Number.isFinite(num)) return '‚Äî';
      return numberFormatter.format(Math.round(num));
    }

    function formatMetricValue(value) {
      if (value === null || value === undefined) return '‚Äî';
      const num = Number(value);
      if (!Number.isFinite(num)) return '‚Äî';
      return Math.round(num);
    }

    function syncAnalyzerConfidence(percent) {
      const analyzerRoot = document.querySelector('#gemma-advanced-analyzer');
      if (!analyzerRoot || percent === null || percent === undefined) return;
      const slider = analyzerRoot.querySelector('[data-role="emotion-confidence-range"]');
      const label = analyzerRoot.querySelector('[data-role="emotion-confidence-label"]');
      if (slider) slider.value = percent;
      if (label) label.textContent = `${percent}%`;
      analyzerRoot.querySelectorAll('[data-role="emotion-pill"]').forEach((pill) => {
        if (pill) pill.textContent = `${percent}%`;
      });
    }

    // Quick Actions -> Advanced Analyzer (prompt + run quick)
    async function quickAnalysis(type) {
      const prompts = {
        summary: 'Summarize the most important points from recent conversations.',
        personality: 'Analyze the personality traits shown in recent discussions.',
        patterns: 'What communication patterns have emerged lately?',
      };
      try {
        if (typeof toggleAdvancedAnalysis === 'function') {
          const content = document.getElementById('advanced-analysis-content');
          if (content && content.style.display === 'none') {
            toggleAdvancedAnalysis();
          }
        }
        const mount = document.querySelector('#gemma-advanced-analyzer');
        if (!mount) return;
        const promptEl = mount.querySelector('textarea[data-role="prompt"]');
        const runQuickBtn = mount.querySelector('button[data-role="run-quick"]');
        if (promptEl) promptEl.value = prompts[type] || prompts.summary;
        if (runQuickBtn) runQuickBtn.click();
      } catch (e) {
        console.warn('Quick action failed', e);
      }
    }
    window.quickAnalysis = quickAnalysis;
    async function loadGPUStats() {
      try {
        const stats = await api.getGemmaStats();
        console.debug('[GEMMA] Stats', stats);
        if (!stats) return;

        if (stats.model_on_gpu !== undefined) {
          document.getElementById('inference-speed').textContent = stats.model_on_gpu ? '~30 tok/s' : '~10 tok/s (CPU)';
        }

        if (stats.vram_used_mb !== undefined && stats.vram_total_mb) {
          const used = Math.round(stats.vram_used_mb / 1024 * 10) / 10;
          const total = Math.round(stats.vram_total_mb / 1024 * 10) / 10;
          document.getElementById('gpu-memory').textContent = `${used} / ${total} GB`;
        }
      } catch (error) {
        console.error('Failed to load GPU stats:', error);
      }
    }

    // Initialize page with authentication
    async function initPage() {
      // Enforce authentication
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;

      // Load GPU stats
      await loadGPUStats();

      await initGemmaControls();

      // Make sure the analyzer is ready without extra clicks
      ensureAdvancedAnalysisReady();
    }
    // ========================================================================
    // ADVANCED ANALYSIS
    // ========================================================================

    let advancedAnalyzerInstance = null;

    function ensureAdvancedAnalysisReady() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      if (content) {
        content.style.display = 'block';
      }
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
      if (typeof initGemmaAnalyzer === 'function') {
        if (!advancedAnalyzerInstance) {
          advancedAnalyzerInstance = initGemmaAnalyzer({ mount: '#gemma-advanced-analyzer' });
        } else if (advancedAnalyzerInstance.refreshCount) {
          advancedAnalyzerInstance.refreshCount();
        }
      }
      syncAnalyzerConfidence(gemmaConfidencePercent);
      syncAnalyzerEmotionsFromState();
    }

    function toggleAdvancedAnalysis() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      const isHidden = content.style.display === 'none';

      content.style.display = isHidden ? 'block' : 'none';
      icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

      if (isHidden) {
        ensureAdvancedAnalysisReady();
      }

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    window.toggleAdvancedAnalysis = toggleAdvancedAnalysis;

    // ================================================
    // Tab Switching
    // ================================================
    function initTabs() {
      const tabs = document.querySelectorAll('.gemma-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.gemma-tab');
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Update tab content
      const contents = document.querySelectorAll('.gemma-tab-content');
      contents.forEach(content => {
        const shouldBeActive = content.id === `tab-${tabName}`;
        content.classList.toggle('active', shouldBeActive);
        content.style.display = shouldBeActive ? 'block' : 'none';
      });

      // Load data for specific tabs on first view
      if (tabName === 'transcripts' && !transcriptsLoaded) {
        loadTranscriptList();
      }
      if (tabName === 'emotions' && !emotionsLoaded) {
        loadEmotionsDashboard();
      }

      // Re-render icons for the new tab
      if (window.lucide && window.lucide.createIcons) {
        setTimeout(() => window.lucide.createIcons(), 50);
      }
    }

    // ================================================
    // Transcriptions Tab
    // ================================================
    let transcriptsLoaded = false;
    let allTranscripts = [];
    let currentTranscriptIndex = -1;

    async function loadTranscriptList() {
      const listEl = document.getElementById('transcript-list');
      if (!listEl) return;

      try {
        const response = await fetch('/api/transcripts?limit=50', {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load transcripts');

        const data = await response.json();
        allTranscripts = data.transcripts || data || [];
        transcriptsLoaded = true;

        if (allTranscripts.length === 0) {
          listEl.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p class="text-muted">No transcripts available yet.</p>
            </div>
          `;
          return;
        }

        listEl.innerHTML = allTranscripts.map((t, idx) => `
          <div class="transcript-item" onclick="viewTranscript(${idx})">
            <div class="transcript-info">
              <span class="transcript-title">${escapeHtml(t.filename || t.job_id || 'Transcript ' + (idx + 1))}</span>
              <span class="transcript-meta">
                ${new Date(t.created_at || t.timestamp || Date.now()).toLocaleDateString()} ‚Ä¢
                ${t.duration ? formatDuration(t.duration) : ''}
                ${t.speaker_count ? t.speaker_count + ' speakers' : ''}
              </span>
            </div>
            <i data-lucide="chevron-right" style="width: 20px; height: 20px; color: var(--text-secondary);"></i>
          </div>
        `).join('');

        lucide.createIcons();

      } catch (error) {
        console.error('Error loading transcripts:', error);
        listEl.innerHTML = '<p class="text-muted">Error loading transcripts.</p>';
      }
    }

    function viewTranscript(index) {
      currentTranscriptIndex = index;
      const transcript = allTranscripts[index];
      if (!transcript) return;

      document.getElementById('transcript-list').style.display = 'none';
      document.getElementById('transcript-viewer').style.display = 'block';
      document.getElementById('transcript-nav').style.display = 'flex';

      updateTranscriptNav();
      loadTranscriptDetail(transcript.job_id || transcript.id);
    }

    // Emotion colors for badges
    const EMOTION_COLORS = {
      joy: '#10b981',
      anger: '#ef4444',
      sadness: '#3b82f6',
      fear: '#8b5cf6',
      surprise: '#f59e0b',
      disgust: '#84cc16',
      neutral: '#6b7280'
    };

    let currentTranscriptSegments = [];
    let activeEmotionFilter = 'all';
    let currentTranscriptJobId = null;

    async function loadTranscriptDetail(jobId) {
      const viewer = document.getElementById('transcript-viewer');
      viewer.innerHTML = '<div class="skeleton" style="height: 200px;"></div>';
      currentTranscriptJobId = jobId;

      // Show insights panel
      const insightsPanel = document.getElementById('transcript-insights-panel');
      if (insightsPanel) insightsPanel.style.display = 'block';

      try {
        const response = await fetch(`/api/transcripts/${jobId}`, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load transcript');

        const data = await response.json();
        currentTranscriptSegments = data.segments || data.transcript || [];

        // Update metrics
        const speakers = new Set(currentTranscriptSegments.map(s => s.speaker).filter(Boolean));
        const duration = currentTranscriptSegments.length > 0
          ? currentTranscriptSegments[currentTranscriptSegments.length - 1].end || currentTranscriptSegments[currentTranscriptSegments.length - 1].start || 0
          : 0;
        const emotionCounts = {};
        currentTranscriptSegments.forEach(s => {
          const e = s.emotion || 'neutral';
          emotionCounts[e] = (emotionCounts[e] || 0) + 1;
        });
        const dominantEmotion = Object.entries(emotionCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';

        document.getElementById('metric-segments').textContent = currentTranscriptSegments.length;
        document.getElementById('metric-speakers').textContent = speakers.size || '-';
        document.getElementById('metric-duration').textContent = formatDuration(duration);
        document.getElementById('metric-emotion').textContent = dominantEmotion.charAt(0).toUpperCase() + dominantEmotion.slice(1);

        // Load saved notes
        loadTranscriptNotes(jobId);

        // Render segments with emotion badges
        renderTranscriptSegments();

      } catch (error) {
        console.error('Error loading transcript detail:', error);
        viewer.innerHTML = '<p class="text-muted">Error loading transcript details.</p>';
      }
    }

    function renderTranscriptSegments() {
      const viewer = document.getElementById('transcript-viewer');
      const filtered = activeEmotionFilter === 'all'
        ? currentTranscriptSegments
        : currentTranscriptSegments.filter(s => (s.emotion || 'neutral') === activeEmotionFilter);

      if (filtered.length === 0) {
        viewer.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">No segments match the selected emotion filter.</p>';
        return;
      }

      viewer.innerHTML = filtered.map(seg => {
        const emotion = seg.emotion || 'neutral';
        const color = EMOTION_COLORS[emotion] || '#6b7280';
        return `
          <div class="transcript-segment" data-time="${seg.start || 0}" data-emotion="${emotion}" style="border-left: 3px solid ${color};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
              <span style="font-weight: 500; color: var(--primary);">${escapeHtml(seg.speaker || 'Speaker')}</span>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="emotion-badge" style="background: ${color}20; color: ${color}; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 500;">
                  ${emotion.charAt(0).toUpperCase() + emotion.slice(1)}
                </span>
                <span style="font-size: 0.8rem; color: var(--text-secondary);">${formatTime(seg.start || 0)}</span>
              </div>
            </div>
            <p style="margin: 0; line-height: 1.5;">${escapeHtml(seg.text || seg.content || '')}</p>
          </div>
        `;
      }).join('');
    }

    function filterTranscriptsByEmotion(emotion) {
      activeEmotionFilter = emotion;

      // Update chip states
      document.querySelectorAll('#transcript-emotion-filters .chip-toggle').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.emotion === emotion);
      });

      // Re-render segments
      if (currentTranscriptSegments.length > 0) {
        renderTranscriptSegments();
      }
    }

    // Notes management
    function loadTranscriptNotes(jobId) {
      const notesEl = document.getElementById('transcript-notes');
      if (!notesEl) return;
      const saved = localStorage.getItem(`transcript_notes_${jobId}`) || '';
      notesEl.value = saved;
    }

    function saveTranscriptNotes() {
      if (!currentTranscriptJobId) return;
      const notes = document.getElementById('transcript-notes').value;
      localStorage.setItem(`transcript_notes_${currentTranscriptJobId}`, notes);

      // Visual feedback
      const btn = document.getElementById('save-notes-btn');
      const original = btn.innerHTML;
      btn.innerHTML = '<i data-lucide="check" style="width: 14px; height: 14px;"></i> Saved!';
      btn.disabled = true;
      setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
        if (window.lucide) lucide.createIcons();
      }, 1500);
    }

    // AI Summary generation
    async function generateTranscriptSummary() {
      if (!currentTranscriptJobId || currentTranscriptSegments.length === 0) return;

      const btn = document.getElementById('generate-summary-btn');
      const insightsEl = document.getElementById('ai-insights');
      const contentEl = document.getElementById('ai-insights-content');

      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader" style="width: 14px; height: 14px;" class="animate-spin"></i> Generating...';
      insightsEl.style.display = 'block';
      contentEl.innerHTML = '<div class="skeleton" style="height: 60px;"></div>';

      try {
        // Build transcript text for summarization
        const transcriptText = currentTranscriptSegments
          .map(s => `${s.speaker || 'Speaker'}: ${s.text || s.content || ''}`)
          .join('\n');

        const prompt = `Analyze this conversation transcript and provide:
1. A brief summary (2-3 sentences)
2. Key themes or topics discussed
3. Notable emotional moments
4. Action items if any

Transcript:
${transcriptText.slice(0, 4000)}`;

        const response = await fetch('/gemma/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            message: prompt,
            context: 'transcript_analysis'
          })
        });

        if (!response.ok) throw new Error('Failed to generate summary');

        const data = await response.json();
        const summary = data.response || data.message || data.text || 'No summary generated.';

        // Format and display
        contentEl.innerHTML = `<div style="white-space: pre-wrap;">${escapeHtml(summary)}</div>`;

      } catch (error) {
        console.error('Summary generation error:', error);
        contentEl.innerHTML = '<p class="text-muted">Failed to generate summary. Please try again.</p>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="wand-2" style="width: 14px; height: 14px;"></i> Generate Summary';
        if (window.lucide) lucide.createIcons();
      }
    }

    // Export new functions globally
    window.filterTranscriptsByEmotion = filterTranscriptsByEmotion;
    window.saveTranscriptNotes = saveTranscriptNotes;
    window.generateTranscriptSummary = generateTranscriptSummary;

    function navigateTranscript(direction) {
      if (direction === 'prev' && currentTranscriptIndex > 0) {
        viewTranscript(currentTranscriptIndex - 1);
      } else if (direction === 'next' && currentTranscriptIndex < allTranscripts.length - 1) {
        viewTranscript(currentTranscriptIndex + 1);
      }
    }

    function updateTranscriptNav() {
      document.getElementById('transcript-position').textContent =
        `${currentTranscriptIndex + 1} of ${allTranscripts.length}`;
      document.getElementById('prev-transcript-btn').disabled = currentTranscriptIndex <= 0;
      document.getElementById('next-transcript-btn').disabled = currentTranscriptIndex >= allTranscripts.length - 1;
    }

    function returnToTranscriptList() {
      document.getElementById('transcript-list').style.display = 'block';
      document.getElementById('transcript-viewer').style.display = 'none';
      document.getElementById('transcript-nav').style.display = 'none';
      const insightsPanel = document.getElementById('transcript-insights-panel');
      if (insightsPanel) insightsPanel.style.display = 'none';
      currentTranscriptIndex = -1;
      activeEmotionFilter = 'all';
      // Reset filter chips
      document.querySelectorAll('#transcript-emotion-filters .chip-toggle').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.emotion === 'all');
      });
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function formatDuration(seconds) {
      const m = Math.floor(seconds / 60);
      return `${m} min`;
    }

    // ================================================
    // Emotions Tab (Modular Integration)
    // ================================================

    // Utility for HTML escaping
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    let emotionsLoaded = false;
    let emotionsModule = null;
    let emotionsPieChart = null;
    let emotionsTrendChart = null;
    let emotionsRadarChart = null;
    let currentEmotionsPeriod = 'today';

    async function loadEmotionsDashboard(period = 'today') {
      currentEmotionsPeriod = period;

      try {
        const response = await fetch(`/emotions/analytics?period=${period}`, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load emotion analytics');

        const analytics = await response.json();
        emotionsLoaded = true;

        // Update stat cards
        const summary = analytics.summary || analytics;
        document.getElementById('stat-joy').textContent = summary.joy_count || summary.joy || 0;
        document.getElementById('stat-negative').textContent =
          (summary.anger || 0) + (summary.sadness || 0) + (summary.fear || 0);
        document.getElementById('stat-total').textContent = summary.total_analyzed || summary.total || 0;
        document.getElementById('stat-pace').textContent = summary.avg_pace_wpm ? Math.round(summary.avg_pace_wpm) : '-';
        document.getElementById('stat-pitch').textContent = summary.avg_pitch_mean ? Math.round(summary.avg_pitch_mean) : '-';

        // Render charts
        const totals = summary.emotion_totals || summary.emotions || {};
        renderEmotionsDistributionChart(totals);
        renderEmotionsTrendChart(analytics.timeline || {});
        renderSpeechRadarChart(analytics.speakers || []);

        // Render speaker table
        renderSpeakerTable(analytics.speakers || []);

        // Load moments
        loadEmotionMoments();

      } catch (error) {
        console.error('Error loading emotions dashboard:', error);
        document.getElementById('stat-joy').textContent = '-';
        document.getElementById('stat-negative').textContent = '-';
        document.getElementById('stat-total').textContent = '-';
      }
    }

    function renderEmotionsDistributionChart(totals) {
      const ctx = document.getElementById('emotion-distribution-chart');
      if (!ctx) return;

      const labels = Object.keys(totals);
      const data = Object.values(totals);
      const colors = labels.map(e => EMOTION_COLORS[e] || '#6b7280');

      if (emotionsPieChart) emotionsPieChart.destroy();

      emotionsPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(k => k.charAt(0).toUpperCase() + k.slice(1)),
          datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } },
          onClick: (evt, active) => {
            if (active.length) {
              const index = active[0].index;
              const emotionKey = labels[index];
              loadEmotionMoments(emotionKey);
              // Update chip UI
              document.querySelectorAll('#moment-emotion-filter .chip-toggle').forEach(c => {
                c.classList.toggle('active', c.dataset.emotion === emotionKey);
              });
            }
          },
          onHover: (event, chartElement) => {
            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
          }
        }
      });
    }

    function renderEmotionsTrendChart(timeline) {
      const ctx = document.getElementById('emotion-trend-chart');
      if (!ctx) return;

      const labels = timeline.labels || [];
      const emotionData = timeline.emotions || {};

      const datasets = Object.entries(emotionData).map(([emotion, values]) => ({
        label: emotion.charAt(0).toUpperCase() + emotion.slice(1),
        data: values,
        borderColor: EMOTION_COLORS[emotion] || '#6b7280',
        backgroundColor: (EMOTION_COLORS[emotion] || '#6b7280') + '20',
        fill: true,
        tension: 0.4
      }));

      if (emotionsTrendChart) emotionsTrendChart.destroy();

      emotionsTrendChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function renderSpeechRadarChart(speakers) {
      const ctx = document.getElementById('speech-radar-chart');
      if (!ctx) return;

      const metrics = ['pace_wpm', 'pitch_mean', 'energy_mean'];
      const labels = ['Pace', 'Pitch', 'Energy'];
      const maxVals = { pace_wpm: 200, pitch_mean: 300, energy_mean: 1 };

      const datasets = speakers.slice(0, 4).map((s, i) => {
        const color = ['#a78bfa', '#f472b6', '#fb923c', '#4ade80'][i];
        return {
          label: s.speaker || 'Unknown',
          data: metrics.map(m => Math.min(100, ((s.speech_metrics?.[m] || 0) / maxVals[m]) * 100)),
          borderColor: color,
          backgroundColor: color + '33',
          pointBackgroundColor: color
        };
      });

      if (emotionsRadarChart) emotionsRadarChart.destroy();

      emotionsRadarChart = new Chart(ctx, {
        type: 'radar',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { r: { beginAtZero: true, max: 100, ticks: { display: false } } },
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function renderSpeakerTable(speakers) {
      const tbody = document.getElementById('speaker-table-body');
      if (!tbody) return;

      if (!speakers.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No speaker data.</td></tr>';
        return;
      }

      tbody.innerHTML = speakers.slice(0, 8).map(s => {
        const emotion = s.dominant_emotion || 'neutral';
        const emotionColor = EMOTION_COLORS[emotion] || '#6b7280';
        const speakerName = s.speaker || 'Unknown';
        return `
          <tr style="cursor: pointer; transition: background 0.2s;" onclick="loadEmotionMoments(null, '${escapeHtml(speakerName)}'); this.parentElement.querySelectorAll('tr').forEach(r => r.style.background=''); this.style.background='rgba(0,82,204,0.05)';" title="Click to filter moments by ${escapeHtml(speakerName)}">
            <td style="padding: 0.5rem;">${escapeHtml(speakerName)}</td>
            <td>${s.segments || 0}</td>
            <td><span style="background:${emotionColor}20;color:${emotionColor};padding:0.1rem 0.4rem;border-radius:999px;font-size:0.75rem;">${emotion}</span></td>
            <td>${s.speech_metrics?.pace_wpm ? Math.round(s.speech_metrics.pace_wpm) : '-'}</td>
            <td>${s.speech_metrics?.pitch_mean ? Math.round(s.speech_metrics.pitch_mean) : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadEmotionMoments(emotion = null, speaker = null) {
      const container = document.getElementById('emotion-moment-feed');
      if (!container) return;

      try {
        let url = `/emotions/moments?limit=20&period=${currentEmotionsPeriod}`;
        if (emotion && emotion !== 'all') url += `&emotion=${encodeURIComponent(emotion)}`;
        if (speaker) url += `&speaker=${encodeURIComponent(speaker)}`;

        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load moments');

        const data = await response.json();
        const moments = data.moments || data.items || data || [];

        if (!moments.length) {
          container.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">No emotional moments yet.</p>';
          return;
        }

        container.innerHTML = moments.slice(0, 15).map(m => {
          const emotionColor = EMOTION_COLORS[m.emotion] || '#6b7280';
          return `
            <div class="moment-card" style="background:#fff;border:1px solid rgba(0,82,204,0.08);border-radius:0.75rem;padding:1rem;margin-bottom:0.75rem;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <span style="font-weight:500;">${escapeHtml(m.speaker || 'Speaker')}</span>
                <span style="background:${emotionColor}20;color:${emotionColor};padding:0.15rem 0.5rem;border-radius:999px;font-size:0.75rem;">
                  ${m.emotion || 'neutral'}
                </span>
              </div>
              <p style="margin:0;color:var(--text-secondary);font-size:0.9rem;line-height:1.5;">${escapeHtml(m.text || '')}</p>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading moments:', error);
        container.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">Failed to load moments.</p>';
      }
    }

    function filterEmotionsPeriod(period) {
      document.querySelectorAll('#emotions-period-chips .chip-toggle').forEach(c => {
        c.classList.toggle('active', c.dataset.period === period);
      });
      loadEmotionsDashboard(period);
    }

    function filterMomentEmotion(emotion) {
      document.querySelectorAll('#moment-emotion-filter .chip-toggle').forEach(c => {
        c.classList.toggle('active', c.dataset.emotion === emotion);
      });
      loadEmotionMoments(emotion);
    }

    // Export functions globally
    window.filterEmotionsPeriod = filterEmotionsPeriod;
    window.filterMomentEmotion = filterMomentEmotion;

    // ================================================
    // Search Tab
    // ================================================
    async function performSemanticSearch() {
      const input = document.getElementById('semantic-search-input');
      const resultsEl = document.getElementById('search-results');

      if (!input || !input.value.trim()) return;

      const query = input.value.trim();
      resultsEl.innerHTML = '<div class="skeleton" style="height: 100px;"></div>';

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ query, limit: 10 })
        });

        if (!response.ok) throw new Error('Search failed');

        const data = await response.json();
        const results = data.results || data || [];

        if (results.length === 0) {
          resultsEl.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">No results found.</p>';
          return;
        }

        resultsEl.innerHTML = results.map(r => `
          <div class="search-result-item" onclick="jumpToSearchResult('${r.job_id || ''}', ${r.start_time || 0})">
            <div class="result-title">${escapeHtml(r.speaker || 'Speaker')} - ${r.filename || 'Transcript'}</div>
            <div class="result-snippet">${highlightQuery(r.text || r.content || '', query)}</div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Search error:', error);
        resultsEl.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">Search failed. Please try again.</p>';
      }
    }

    function highlightQuery(text, query) {
      const escaped = escapeHtml(text);
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escaped.replace(regex, '<mark>$1</mark>');
    }

    function jumpToSearchResult(jobId, startTime) {
      if (jobId) {
        window.location.href = `transcripts.html?job=${jobId}&t=${startTime}`;
      }
    }

    // Export functions globally
    window.viewTranscript = viewTranscript;
    window.navigateTranscript = navigateTranscript;
    window.returnToTranscriptList = returnToTranscriptList;
    window.performSemanticSearch = performSemanticSearch;
    window.jumpToSearchResult = jumpToSearchResult;

    // ================================================
    // Chat Functionality
    // ================================================

    // Conversation history for context (limited to avoid token overflow)
    const chatHistory = [];
    const MAX_HISTORY = 6; // Keep last 6 messages (3 exchanges) to stay under 8k context

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addChatMessage(message, 'user');

      // Add to history for general chat mode
      chatHistory.push({ role: 'user', content: message });

      // Trim history if too long to prevent OOM
      while (chatHistory.length > MAX_HISTORY) {
        chatHistory.shift();
      }

      // Show thinking indicator
      const thinkingId = addThinkingIndicator();

      try {
        let response, aiResponse;

        if (activeDatabase && activeDatabase.isReady) {
          // ========================================
          // RAG MODE: Query the active database
          // ========================================
          response = await fetch('/ask', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filename: activeDatabase.filename,
              question: message
            })
          });

          if (response.ok) {
            const data = await response.json();
            aiResponse = data.answer || 'I couldn\'t find relevant information in the database.';

            // Add source context if available
            if (data.context && data.context.length > 0) {
              aiResponse += `\n\nüìã *Based on: ${activeDatabase.displayName}*`;
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            aiResponse = `Sorry, I couldn't query the database: ${errorData.detail || 'Unknown error'}`;
          }
        } else {
          // ========================================
          // GENERAL CHAT MODE: No database context
          // ========================================
          response = await fetch('/api/public/chat', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: chatHistory,
              max_tokens: 500,
              temperature: 0.7,
              top_p: 0.9
            })
          });

          if (response.ok) {
            const data = await response.json();
            aiResponse = data.message || data.text || 'I received your message but had trouble generating a response.';

            // Add AI response to history
            chatHistory.push({ role: 'assistant', content: aiResponse });

            // Trim again after adding response
            while (chatHistory.length > MAX_HISTORY) {
              chatHistory.shift();
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg = errorData.detail || errorData.message || `Error ${response.status}`;
            aiResponse = `Sorry, I encountered an error: ${errorMsg}`;
          }
        }

        removeThinkingIndicator(thinkingId);
        addChatMessage(aiResponse, 'ai');

      } catch (error) {
        console.error('Chat error:', error);
        removeThinkingIndicator(thinkingId);
        addChatMessage('Connection error. Please check your connection and try again.', 'ai');
      }
    }

    function addThinkingIndicator() {
      const container = document.getElementById('chat-messages');
      const id = 'thinking-' + Date.now();
      const html = `
        <div id="${id}" class="chat-message-row">
          <div class="chat-avatar-icon ai-avatar">
            <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
          </div>
          <div class="chat-bubble-content ai-bubble">
            <div class="thinking-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
      container.scrollTop = container.scrollHeight;
      lucide.createIcons();
      return id;
    }

    function removeThinkingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function addChatMessage(text, sender) {
      const container = document.getElementById('chat-messages');
      const isUser = sender === 'user';

      // Simple markdown renderer for AI messages
      let formattedText = text;
      if (!isUser) {
        formattedText = renderMarkdown(text);
      }

      const messageHtml = `
        <div class="chat-message-row ${isUser ? 'user' : ''}">
          ${!isUser ? `
            <div class="chat-avatar-icon ai-avatar">
              <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
            </div>
          ` : ''}
          <div class="chat-bubble-content ${isUser ? 'user-bubble' : 'ai-bubble'}">
            ${formattedText}
          </div>
          ${isUser ? `
            <div class="chat-avatar-icon user-avatar">
              <i data-lucide="user" style="width: 18px; height: 18px; color: white;"></i>
            </div>
          ` : ''}
        </div>
      `;

      container.insertAdjacentHTML('beforeend', messageHtml);
      container.scrollTop = container.scrollHeight;

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    function renderMarkdown(text) {
      // Escape HTML first
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Headers (## and ###)
      html = html.replace(/^### (.+)$/gm, '<h4 style="margin: 0.8em 0 0.4em; color: #a78bfa; font-size: 0.95em;">$1</h4>');
      html = html.replace(/^## (.+)$/gm, '<h3 style="margin: 1em 0 0.5em; color: #c4b5fd; font-size: 1.05em;">$1</h3>');

      // Bold (**text** or __text__)
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #e0d4ff;">$1</strong>');
      html = html.replace(/__([^_]+)__/g, '<strong style="color: #e0d4ff;">$1</strong>');

      // Italic (*text* or _text_)
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

      // Bullet points (* or -)
      html = html.replace(/^\s*[\*\-]\s+(.+)$/gm, '<li style="margin: 0.3em 0; padding-left: 0.5em;">$1</li>');

      // Wrap consecutive <li> in <ul>
      html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/g, (match) => {
        return `<ul style="margin: 0.5em 0; padding-left: 1.2em; list-style-type: disc;">${match}</ul>`;
      });

      // Numbers (1. 2. etc)
      html = html.replace(/^\s*(\d+)\.\s+(.+)$/gm, '<li style="margin: 0.3em 0;">$2</li>');

      // Code inline (`code`)
      html = html.replace(/`([^`]+)`/g, '<code style="background: rgba(139, 92, 246, 0.2); padding: 0.1em 0.4em; border-radius: 4px; font-size: 0.9em;">$1</code>');

      // Line breaks (double newline = paragraph, single = br)
      html = html.replace(/\n\n+/g, '</p><p style="margin: 0.8em 0;">');
      html = html.replace(/\n/g, '<br>');

      // Wrap in paragraph
      html = `<div style="line-height: 1.6;">${html}</div>`;

      return html;
    }

    function useQuickPrompt(prompt) {
      document.getElementById('chat-input').value = prompt;
      sendChatMessage();
    }

    // Chat input enter key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'chat-input') {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // ================================================
    // Database Upload
    // ================================================
    function initDatabaseUpload() {
      const dropZone = document.getElementById('db-upload-zone');
      if (!dropZone) return;

      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
        if (files.length > 0) {
          processUploadedFiles(files);
        }
      });
    }

    function handleDatabaseUpload(event) {
      const files = Array.from(event.target.files).filter(f => f.name.endsWith('.csv'));
      if (files.length > 0) {
        processUploadedFiles(files);
      }
    }

    async function processUploadedFiles(files) {
      const listContainer = document.getElementById('db-file-list');

      for (const file of files) {
        // Add file to list with pending status
        const fileId = `file-${Date.now()}`;
        const fileHtml = `
          <div class="db-file-item" id="${fileId}">
            <div class="db-file-info">
              <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
              <div>
                <div style="font-weight: 500;">${file.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</div>
              </div>
            </div>
            <span class="db-file-status pending">Pending</span>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', fileHtml);
        if (window.lucide) window.lucide.createIcons();

        const statusEl = document.querySelector(`#${fileId} .db-file-status`);

        try {
          // Step 1: Upload file
          statusEl.textContent = 'Uploading...';
          statusEl.className = 'db-file-status processing';

          const formData = new FormData();
          formData.append('file', file);

          const uploadResponse = await fetch('/upload', {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });

          const uploadData = await uploadResponse.json();

          if (!uploadResponse.ok || !uploadData.filename) {
            throw new Error(uploadData.detail || 'Upload failed');
          }

          // Step 2: Run full ML analysis (this caches insights for Q&A)
          statusEl.textContent = 'Running ML analysis...';

          try {
            const analyzeResponse = await fetch(`/analyze-full/${uploadData.filename}`, {
              method: 'POST',
              credentials: 'include'
            });

            if (analyzeResponse.ok) {
              const analyzeData = await analyzeResponse.json();
              console.log('‚úÖ Full analysis complete:', analyzeData.analyses_run);
              statusEl.textContent = 'Analysis complete...';
            } else {
              console.warn('Full analysis failed, will use basic mode');
            }
          } catch (analyzeError) {
            console.warn('Analysis error (non-fatal):', analyzeError);
          }

          // Step 3: Create embeddings for semantic search (optional, runs in background)
          statusEl.textContent = 'Creating search index...';

          fetch('/embed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ filename: uploadData.filename })
          }).then(r => {
            if (!r.ok) console.warn('Embedding creation failed, will use cached analysis');
          }).catch(e => console.warn('Embedding error:', e));

          // Step 4: Set as active database
          setActiveDatabase({
            filename: uploadData.filename,
            displayName: file.name,
            columns: uploadData.columns || [],
            isReady: true
          });

          statusEl.textContent = '‚úÖ Ready';
          statusEl.className = 'db-file-status complete';

          // Show success message in chat
          switchTab('chat');
          addChatMessage(`üìä Database "${file.name}" analyzed and ready! Ask me anything about your data - I've already analyzed the distributions, correlations, and anomalies.`, 'ai');

        } catch (error) {
          console.error('Upload error:', error);
          statusEl.textContent = `Error: ${error.message}`;
          statusEl.className = 'db-file-status pending';
        }
      }
    }

    // ================================================
    // Saved Databases Management
    // ================================================
    async function loadSavedDatabases() {
      const container = document.getElementById('existing-databases');
      if (!container) return;

      try {
        const response = await fetch('/databases', { credentials: 'include' });
        if (!response.ok) {
          container.innerHTML = '<p class="text-muted">Could not load databases.</p>';
          return;
        }

        const data = await response.json();

        if (!data.databases || data.databases.length === 0) {
          container.innerHTML = '<p class="text-muted">No databases uploaded yet. Upload a CSV to get started!</p>';
          return;
        }

        container.innerHTML = `
          <div class="saved-db-list">
            ${data.databases.map(db => `
              <div class="saved-db-item ${activeDatabase?.filename === db.filename ? 'active' : ''}">
                <div class="db-info">
                  <i data-lucide="${db.has_embeddings ? 'database' : 'file'}" style="width: 18px; height: 18px; color: ${db.has_embeddings ? 'var(--primary)' : 'var(--text-muted)'};"></i>
                  <div>
                    <div class="db-name">${db.display_name}</div>
                    <div class="db-meta">${(db.size_bytes / 1024).toFixed(1)} KB ${db.has_embeddings ? '‚Ä¢ Indexed' : ''}</div>
                  </div>
                </div>
                <div class="db-actions">
                  ${db.has_embeddings
            ? `<button class="btn-use" onclick="selectDatabase('${db.filename}', '${db.display_name.replace(/'/g, "\\'")}')">
                         ${activeDatabase?.filename === db.filename ? '‚úì Active' : 'Use'}
                       </button>`
            : `<button class="btn-embed" onclick="embedDatabase('${db.filename}', this)">Index</button>`
          }
                </div>
              </div>
            `).join('')}
          </div>
        `;

        lucide.createIcons();

      } catch (error) {
        console.error('Error loading databases:', error);
        container.innerHTML = '<p class="text-muted">Error loading databases.</p>';
      }
    }

    function selectDatabase(filename, displayName) {
      setActiveDatabase({
        filename,
        displayName,
        columns: [],
        isReady: true
      });

      // Notify user and switch to chat
      switchTab('chat');
      addChatMessage(`üìä Switched to database "${displayName}". Ask me anything about it!`, 'ai');
    }

    async function embedDatabase(filename, buttonEl) {
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Indexing...';
      }

      try {
        const response = await fetch('/embed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ filename })
        });

        if (response.ok) {
          loadSavedDatabases(); // Refresh list
        } else {
          const data = await response.json().catch(() => ({}));
          alert(`Failed to create index: ${data.detail || 'Unknown error'}`);
          if (buttonEl) {
            buttonEl.disabled = false;
            buttonEl.textContent = 'Index';
          }
        }
      } catch (error) {
        console.error('Embed error:', error);
        alert('Failed to create index. Please try again.');
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = 'Index';
        }
      }
    }

    // Make functions available globally
    window.sendChatMessage = sendChatMessage;
    window.useQuickPrompt = useQuickPrompt;
    window.handleDatabaseUpload = handleDatabaseUpload;
    window.selectDatabase = selectDatabase;
    window.embedDatabase = embedDatabase;
    window.clearActiveDatabase = clearActiveDatabase;

    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        initPage();
        initTabs();
        initDatabaseUpload();
        await restoreActiveDatabase();
        loadSavedDatabases();
      });
    } else {
      initPage();
      initTabs();
      initDatabaseUpload();
      restoreActiveDatabase().then(() => loadSavedDatabases());
    }
  </script>

</body>

</html>