<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data: https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <title>Nemo Server - Gemma AI</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <link rel="stylesheet" href="assets/css/main.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/design-tokens.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/components.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/animations.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/analyzer.css?v=2024110802">
  
  <script>
    window.__ASSET_VERSION__ = '2024110802';
  </script>
  <script src="assets/js/api.js?v=2024110101"></script>
  <script src="assets/js/app.js?v=2024110101"></script>
  <script src="assets/js/auth.js?v=2024110101"></script>
  <script src="assets/js/gemma_analyzer_ui.js?v=2024110802"></script>
  
  <style>
    .chat-container {
      max-width: 900px;
      margin: 0 auto;
      height: 600px;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .chat-message {
      display: flex;
      gap: 1rem;
      animation: fadeInUp 0.3s ease;
    }
    .chat-message.user {
      justify-content: flex-end;
    }
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-avatar.ai {
      background: var(--gradient-primary);
    }
    .chat-avatar.user {
      background: var(--gradient-success);
    }
    .chat-bubble {
      max-width: 70%;
      padding: 1rem;
      border-radius: var(--radius-lg);
      line-height: 1.6;
    }
    .chat-bubble.ai {
      background: var(--glass);
      border: 1px solid var(--glass-border);
    }
    .chat-bubble.user {
      background: var(--primary);
      color: white;
    }
    .chat-input-container {
      border-top: 1px solid var(--glass-border);
      padding: 1.5rem;
    }
    
    /* Date range button styles */
    .date-range-btn {
      transition: all 0.2s ease;
    }
    .date-range-btn.active {
      background: var(--primary) !important;
      color: white !important;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    .date-range-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Pulse animation for count */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="gemma-theme">
  
  <header class="glass-header">
    <div class="container">
      <div class="flex-between">
        <div class="flex">
          <h1 style="font-size: 1.5rem; margin: 0; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üéôÔ∏è Nemo Server
          </h1>
        </div>
        
        <nav class="nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="search.html" class="nav-link">Search</a>
          <a href="emotions.html" class="nav-link">Emotions</a>
          <a href="memories.html" class="nav-link">Memories</a>
          <a href="gemma.html" class="nav-link active">AI Insights</a>
          <a href="settings.html" class="nav-link">Settings</a>
        </nav>
        
        <div class="flex" style="gap: 1rem; align-items: center;">
          <span id="current-user" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
          <button id="logout-btn" class="glass-button" style="display: none;" title="Logout">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
          </button>
          <button class="glass-button" data-toggle-theme>
            <i data-lucide="moon" style="width: 18px; height: 18px;"></i>
          </button>
          <div id="api-status"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    <div class="gemma-shell">
    
    <section class="fade-in-up" style="text-align: center; margin-bottom: 2rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Gemma AI Insights</h1>
      <p class="text-muted">GPU-accelerated analysis with personality detection & summarization</p>
    </section>

    <!-- Stats -->
    <section class="grid grid-3 fade-in-up delay-100 gemma-hero-stats" style="margin-bottom: 2rem;">
      <div class="stat-card">
        <i data-lucide="cpu" style="width: 28px; height: 28px; color: var(--primary); margin-bottom: 0.5rem;"></i>
        <div class="stat-value">Gemma 3 4B</div>
        <div class="stat-label">AI Model (Q4_K_M)</div>
      </div>
      
      <div class="stat-card">
        <i data-lucide="zap" style="width: 28px; height: 28px; color: var(--success); margin-bottom: 0.5rem;"></i>
        <div class="stat-value" id="gpu-memory">~4GB</div>
        <div class="stat-label">GPU VRAM Usage</div>
      </div>
      
      <div class="stat-card">
        <i data-lucide="activity" style="width: 28px; height: 28px; color: var(--warning); margin-bottom: 0.5rem;"></i>
        <div class="stat-value" id="inference-speed">~30 tok/s</div>
        <div class="stat-label">Inference Speed</div>
      </div>
    </section>

    <!-- Chat Interface removed; use analyzer chat drawer (bottom/overlay) to avoid cramped layout. -->

    <!-- Advanced Analysis Section -->
    <section class="fade-in-up delay-300" style="margin-top: 2rem;">
      <div class="glass-card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; cursor: pointer;" onclick="toggleAdvancedAnalysis()">
          <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="brain" style="width: 24px; height: 24px; color: var(--primary);"></i>
            Advanced Conversation Analysis
          </h3>
          <i data-lucide="chevron-down" id="analysis-toggle-icon" style="width: 20px; height: 20px; transition: transform 0.3s;"></i>
        </div>
        
        <div id="advanced-analysis-content" style="display: block;">
          <p class="text-muted" style="margin-bottom: 1.5rem;">
            Analyze conversations for patterns, fallacies, emotional triggers. Customize the analysis prompt and filters.
          </p>
          <div id="gemma-advanced-analyzer"></div>
        </div></div>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="grid grid-2 fade-in-up delay-300 gemma-quick-actions" style="margin-top: 2rem;">
      <div class="glass-card">
        <h4 style="margin-bottom: 1rem;">Quick Actions</h4>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button class="btn btn-ghost" onclick="quickAnalysis('summary')">
            <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
            Generate Summary
          </button>
          <button class="btn btn-ghost" onclick="quickAnalysis('personality')">
            <i data-lucide="user" style="width: 16px; height: 16px;"></i>
            Analyze Personality
          </button>
          <button class="btn btn-ghost" onclick="quickAnalysis('patterns')">
            <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
            Find Patterns
          </button>
        </div>
      </div>
      
      <div class="glass-card">
        <h4 style="margin-bottom: 1rem;">Example Questions</h4>
        <div style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.8;">
          ‚Ä¢ "What were the main topics discussed today?"<br>
          ‚Ä¢ "Analyze the personality of Speaker 1"<br>
          ‚Ä¢ "What emotions dominated this week?"<br>
          ‚Ä¢ "Summarize the last conversation"
        </div>
      </div>
    </section>

    </div>
  </main>

  <script>
    lucide.createIcons();

    // Quick Actions -> Advanced Analyzer (prompt + run quick)
    async function quickAnalysis(type) {
      const prompts = {
        summary: 'Summarize the most important points from recent conversations.',
        personality: 'Analyze the personality traits shown in recent discussions.',
        patterns: 'What communication patterns have emerged lately?',
      };
      try {
        if (typeof toggleAdvancedAnalysis === 'function') {
          const content = document.getElementById('advanced-analysis-content');
          if (content && content.style.display === 'none') {
            toggleAdvancedAnalysis();
          }
        }
        const mount = document.querySelector('#gemma-advanced-analyzer');
        if (!mount) return;
        const promptEl = mount.querySelector('textarea[data-role="prompt"]');
        const runQuickBtn = mount.querySelector('button[data-role="run-quick"]');
        if (promptEl) promptEl.value = prompts[type] || prompts.summary;
        if (runQuickBtn) runQuickBtn.click();
      } catch (e) {
        console.warn('Quick action failed', e);
      }
    }
    window.quickAnalysis = quickAnalysis;
    async function loadGPUStats() {
      try {
        const stats = await api.getGemmaStats();
        console.debug('[GEMMA] Stats', stats);
        if (!stats) return;

        if (stats.model_on_gpu !== undefined) {
          document.getElementById('inference-speed').textContent = stats.model_on_gpu ? '~30 tok/s' : '~10 tok/s (CPU)';
        }

        if (stats.vram_used_mb !== undefined && stats.vram_total_mb) {
          const used = Math.round(stats.vram_used_mb / 1024 * 10) / 10;
          const total = Math.round(stats.vram_total_mb / 1024 * 10) / 10;
          document.getElementById('gpu-memory').textContent = `${used} / ${total} GB`;
        }
      } catch (error) {
        console.error('Failed to load GPU stats:', error);
      }
    }

    // Initialize page with authentication
    async function initPage() {
      // Enforce authentication
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;
      
      // Load GPU stats
      await loadGPUStats();

      // Make sure the analyzer is ready without extra clicks
      ensureAdvancedAnalysisReady();
    }
    // ========================================================================
    // ADVANCED ANALYSIS
    // ========================================================================

    let advancedAnalyzerInstance = null;

    function ensureAdvancedAnalysisReady() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      if (content) {
        content.style.display = 'block';
      }
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
      if (typeof initGemmaAnalyzer === 'function') {
        if (!advancedAnalyzerInstance) {
          advancedAnalyzerInstance = initGemmaAnalyzer({ mount: '#gemma-advanced-analyzer' });
        } else if (advancedAnalyzerInstance.refreshCount) {
          advancedAnalyzerInstance.refreshCount();
        }
      }
    }

    function toggleAdvancedAnalysis() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      const isHidden = content.style.display === 'none';

      content.style.display = isHidden ? 'block' : 'none';
      icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

      if (isHidden) {
        ensureAdvancedAnalysisReady();
      }

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    window.toggleAdvancedAnalysis = toggleAdvancedAnalysis;

    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>

</body>
</html>
