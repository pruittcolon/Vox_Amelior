<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://unpkg.com; img-src 'self' data: https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>Nemo Server - Gemma AI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="stylesheet" href="assets/css/main.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/design-tokens.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/components.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/animations.css?v=2024110802">
  <link rel="stylesheet" href="assets/css/analyzer.css?v=2024110802">

  <script>
    window.__ASSET_VERSION__ = '2024110802';
  </script>
  <script src="assets/js/api.js?v=2024110101"></script>
  <script src="assets/js/app.js?v=2024110101"></script>
  <script src="assets/js/auth.js?v=2024110101"></script>
  <script src="assets/js/gemma_analyzer_ui.js?v=2024110802"></script>

  <style>
    .chat-container {
      max-width: 900px;
      margin: 0 auto;
      height: 600px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chat-message {
      display: flex;
      gap: 1rem;
      animation: fadeInUp 0.3s ease;
    }

    .chat-message.user {
      justify-content: flex-end;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .chat-avatar.ai {
      background: var(--gradient-primary);
    }

    .chat-avatar.user {
      background: var(--gradient-success);
    }

    .chat-bubble {
      max-width: 70%;
      padding: 1rem;
      border-radius: var(--radius-lg);
      line-height: 1.6;
    }

    .chat-bubble.ai {
      background: var(--glass);
      border: 1px solid var(--glass-border);
    }

    .chat-bubble.user {
      background: var(--primary);
      color: white;
    }

    .chat-input-container {
      border-top: 1px solid var(--glass-border);
      padding: 1.5rem;
    }

    /* Date range button styles */
    .date-range-btn {
      transition: all 0.2s ease;
    }

    .date-range-btn.active {
      background: var(--primary) !important;
      color: white !important;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .date-range-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Pulse animation for count */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Emotions UI parity */
    .gemma-filter-panel {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 1.25rem;
      box-shadow: 0 25px 55px rgba(3, 7, 23, 0.6);
      padding: 1.5rem 1.75rem;
    }

    .gemma-filter-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: space-between;
    }

    .gemma-filter-column {
      flex: 1 1 280px;
      min-width: 260px;
    }

    .chip-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.8rem;
      gap: 0.75rem;
    }

    .chip-panel-header h4 {
      margin: 0;
      font-size: 1rem;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      align-items: center;
    }

    .chip-group-center {
      justify-content: center;
    }

    .chip-toggle {
      appearance: none;
      border: 1px solid var(--chip-color, rgba(148, 163, 184, 0.35));
      border-radius: 999px;
      padding: 0.35rem 0.95rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.6);
      color: var(--chip-color, var(--text-secondary));
      transition: all 0.2s ease;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
      letter-spacing: 0.02em;
    }

    .chip-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.45), 0 0 16px rgba(108, 99, 241, 0.3);
    }

    .chip-toggle[aria-pressed="true"] {
      background: radial-gradient(120% 120% at 20% 30%, rgba(108, 99, 241, 0.4), rgba(108, 99, 241, 0.12));
      border-color: rgba(108, 99, 241, 0.85);
      color: #f8fafc;
      box-shadow: 0 0 18px rgba(108, 99, 241, 0.4), inset 0 0 8px rgba(108, 99, 241, 0.45);
    }

    .chip-toggle.chip-all {
      background: linear-gradient(135deg, #6C63FF, #a78bfa);
      border: none;
      color: #0b0f1a;
      font-weight: 600;
      box-shadow: 0 12px 24px rgba(108, 99, 241, 0.5);
    }

    .gemma-period-filter {
      text-align: center;
    }

    .gemma-stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .gemma-stat-card {
      position: relative;
      padding: 1.25rem 1.35rem;
      border-radius: 1.1rem;
      background: rgba(12, 17, 31, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 18px 38px rgba(3, 7, 23, 0.55);
      overflow: hidden;
    }

    .gemma-stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--stat-accent, var(--primary));
      border-radius: 999px;
      opacity: 0.9;
    }

    .gemma-stat-card .stat-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(108, 99, 241, 0.15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.75rem;
      color: var(--stat-accent, var(--primary));
    }

    .gemma-stat-card .stat-value {
      font-size: 1.9rem;
      font-weight: 600;
      margin: 0;
    }

    .gemma-stat-card .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .gemma-stat-card .stat-hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
    }

    .gemma-stat-grid.loading .stat-value {
      opacity: 0.4;
      animation: pulse 1.4s ease infinite;
    }

    .gemma-confidence-control {
      margin-top: 1.5rem;
      padding: 1.25rem 1.5rem;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(9, 13, 24, 0.85);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    .gemma-confidence-control .chip-panel-header {
      margin-bottom: 0.75rem;
      justify-content: space-between;
    }

    .gemma-confidence-control .chip-panel-header span {
      font-size: 1rem;
      font-weight: 600;
      color: #f8fafc;
    }

    .gemma-confidence-slider {
      display: flex;
      align-items: center;
      gap: 0.85rem;
    }

    .gemma-confidence-slider input[type="range"] {
      flex: 1;
    }

    .gemma-confidence-hint {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    @media (max-width: 768px) {
      .gemma-filter-grid {
        flex-direction: column;
      }

      .chip-group-center {
        justify-content: flex-start;
      }
    }

    /* ========================================== */
    /* Enterprise Dropdown Navigation            */
    /* ========================================== */
    .nav-dropdown {
      position: relative;
      display: inline-block;
    }

    .nav-dropdown-trigger {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .nav-dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      min-width: 180px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 0.75rem;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
      padding: 0.5rem 0;
      z-index: 1000;
      backdrop-filter: blur(16px);
    }

    .nav-dropdown:hover .nav-dropdown-menu,
    .nav-dropdown:focus-within .nav-dropdown-menu {
      display: block;
      animation: fadeInUp 0.2s ease;
    }

    .nav-dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.65rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.15s ease;
    }

    .nav-dropdown-item:hover {
      background: rgba(99, 102, 241, 0.15);
      color: var(--text-primary);
    }

    /* ========================================== */
    /* Tabbed Interface                          */
    /* ========================================== */
    .gemma-tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 1.5rem;
    }

    .gemma-tab {
      padding: 0.875rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .gemma-tab:hover {
      color: var(--text-primary);
    }

    .gemma-tab.active {
      color: var(--primary);
    }

    .gemma-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient-primary);
      border-radius: 2px 2px 0 0;
    }

    .gemma-tab-content {
      display: none !important;
    }

    .gemma-tab-content.active {
      display: block !important;
      /* Animation removed - was causing tab switching rendering issues */
    }

    /* ========================================== */
    /* Chat Tab Styles                           */
    /* ========================================== */
    .chat-interface {
      max-width: 900px;
      margin: 0 auto;
      min-height: 500px;
      display: flex;
      flex-direction: column;
    }

    .active-db-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));
      border: 1px solid rgba(139, 92, 246, 0.25);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .active-db-indicator .db-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .active-db-indicator .db-badge {
      margin-left: auto;
      padding: 0.2rem 0.5rem;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
    }

    .btn-clear-db {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0 0.25rem;
      font-size: 1.2rem;
      line-height: 1;
      transition: color 0.2s;
    }

    .btn-clear-db:hover {
      color: var(--danger);
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
      padding: 0.5rem 0;
    }

    .thinking-dots span {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      animation: thinking 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes thinking {

      0%,
      80%,
      100% {
        opacity: 0.3;
        transform: scale(0.8);
      }

      40% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .chat-messages-area {
      flex: 1;
      min-height: 400px;
      max-height: 500px;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: rgba(10, 15, 28, 0.5);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .chat-message-row {
      display: flex;
      gap: 1rem;
    }

    .chat-message-row.user {
      justify-content: flex-end;
    }

    .chat-avatar-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .chat-avatar-icon.ai-avatar {
      background: var(--gradient-primary);
    }

    .chat-avatar-icon.user-avatar {
      background: var(--gradient-success);
    }

    .chat-bubble-content {
      max-width: 70%;
      padding: 1rem;
      border-radius: 1rem;
      line-height: 1.6;
    }

    .chat-bubble-content.ai-bubble {
      background: var(--glass);
      border: 1px solid var(--glass-border);
    }

    .chat-bubble-content.user-bubble {
      background: var(--primary);
      color: white;
    }

    .chat-input-row {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .chat-input-row input {
      flex: 1;
      background: rgba(15, 20, 35, 0.8) !important;
      border: 1px solid rgba(139, 92, 246, 0.3) !important;
      border-radius: 12px !important;
      padding: 0.9rem 1.2rem !important;
      color: #e2e8f0 !important;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
      font-size: 0.95rem !important;
      transition: all 0.2s ease !important;
    }

    .chat-input-row input::placeholder {
      color: rgba(148, 163, 184, 0.6) !important;
      font-style: italic;
    }

    .chat-input-row input:focus {
      outline: none !important;
      border-color: rgba(139, 92, 246, 0.6) !important;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15),
        0 4px 12px rgba(0, 0, 0, 0.3) !important;
      background: rgba(20, 25, 45, 0.9) !important;
    }

    /* ========================================== */
    /* Database Tab Styles                       */
    /* ========================================== */
    .db-upload-zone {
      border: 2px dashed rgba(148, 163, 184, 0.3);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(10, 15, 28, 0.3);
      cursor: pointer;
    }

    .db-upload-zone:hover,
    .db-upload-zone.dragover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .db-upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      color: var(--primary);
      opacity: 0.7;
    }

    .db-file-list {
      margin-top: 1.5rem;
    }

    .db-file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .db-file-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .db-file-status {
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
    }

    .db-file-status.pending {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .db-file-status.processing {
      background: rgba(99, 102, 241, 0.2);
      color: var(--primary);
    }

    .db-file-status.complete {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    /* Saved Databases List */
    .saved-db-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .saved-db-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 0.5rem;
      transition: all 0.2s ease;
    }

    .saved-db-item:hover {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(139, 92, 246, 0.3);
    }

    .saved-db-item.active {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--primary);
    }

    .saved-db-item .db-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .saved-db-item .db-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .saved-db-item .db-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .saved-db-item .db-actions {
      display: flex;
      gap: 0.5rem;
    }

    .saved-db-item .btn-use {
      padding: 0.35rem 0.75rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .saved-db-item .btn-use:hover {
      background: var(--primary-dark);
    }

    .saved-db-item .btn-embed {
      padding: 0.35rem 0.75rem;
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .saved-db-item .btn-embed:hover {
      background: rgba(251, 191, 36, 0.3);
    }

    .saved-db-item.active .btn-use {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      pointer-events: none;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body class="gemma-theme">

  <header class="glass-header">
    <div class="container">
      <div class="flex-between">
        <div class="flex">
          <h1
            style="font-size: 1.5rem; margin: 0; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üéôÔ∏è Nemo Server
          </h1>
        </div>

        <nav class="nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="search.html" class="nav-link">Search</a>
          <a href="emotions.html" class="nav-link">Emotions</a>
          <a href="memories.html" class="nav-link">Memories</a>
          <a href="gemma.html" class="nav-link active">AI Insights</a>
          <a href="databases.html" class="nav-link">LLM Vectorization</a>
          <a href="predictions.html" class="nav-link">ML Service</a>
          <div class="nav-dropdown">
            <button class="nav-link nav-dropdown-trigger">Enterprise <i data-lucide="chevron-down"
                style="width: 12px; height: 12px;"></i></button>
            <div class="nav-dropdown-menu">
              <a href="admin_qa.html" class="nav-dropdown-item"><i data-lucide="message-circle-question"
                  style="width: 14px; height: 14px;"></i> QA Admin</a>
              <a href="automation.html" class="nav-dropdown-item"><i data-lucide="workflow"
                  style="width: 14px; height: 14px;"></i> Automation</a>
              <a href="knowledge.html" class="nav-dropdown-item"><i data-lucide="book-open"
                  style="width: 14px; height: 14px;"></i> Knowledge</a>
              <a href="analytics.html" class="nav-dropdown-item"><i data-lucide="bar-chart-3"
                  style="width: 14px; height: 14px;"></i> Analytics</a>
              <a href="meetings.html" class="nav-dropdown-item"><i data-lucide="calendar-check"
                  style="width: 14px; height: 14px;"></i> Meetings</a>
            </div>
          </div>
          <a href="settings.html" class="nav-link">Settings</a>
        </nav>

        <div class="flex" style="gap: 1rem; align-items: center;">
          <span id="current-user" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
          <button id="logout-btn" class="glass-button" style="display: none;" title="Logout">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
          </button>
          <button class="glass-button" data-toggle-theme>
            <i data-lucide="moon" style="width: 18px; height: 18px;"></i>
          </button>
          <div id="api-status"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    <div class="gemma-shell">

      <section class="fade-in-up" style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Gemma AI Insights</h1>
        <p class="text-muted">GPU-accelerated analysis with personality detection & summarization</p>
      </section>

      <!-- Stats -->
      <section class="grid grid-3 fade-in-up delay-100 gemma-hero-stats" style="margin-bottom: 2rem;">
        <div class="stat-card">
          <i data-lucide="cpu" style="width: 28px; height: 28px; color: var(--primary); margin-bottom: 0.5rem;"></i>
          <div class="stat-value">Gemma 3 4B</div>
          <div class="stat-label">AI Model (Q4_K_M)</div>
        </div>

        <div class="stat-card">
          <i data-lucide="zap" style="width: 28px; height: 28px; color: var(--success); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="gpu-memory">~4GB</div>
          <div class="stat-label">GPU VRAM Usage</div>
        </div>

        <div class="stat-card">
          <i data-lucide="activity"
            style="width: 28px; height: 28px; color: var(--warning); margin-bottom: 0.5rem;"></i>
          <div class="stat-value" id="inference-speed">~30 tok/s</div>
          <div class="stat-label">Inference Speed</div>
        </div>
      </section>

      <!-- Tabbed Interface -->
      <section class="fade-in-up delay-100" style="margin-bottom: 1.5rem;">
        <div class="gemma-tabs">
          <button class="gemma-tab active" data-tab="analytics">
            <i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i>
            Analytics
          </button>
          <button class="gemma-tab" data-tab="chat">
            <i data-lucide="message-circle" style="width: 18px; height: 18px;"></i>
            Chat
          </button>
          <button class="gemma-tab" data-tab="databases">
            <i data-lucide="database" style="width: 18px; height: 18px;"></i>
            Databases
          </button>
        </div>
      </section>

      <!-- ============================================ -->
      <!-- Tab Content: Analytics                       -->
      <!-- ============================================ -->
      <div id="tab-analytics" class="gemma-tab-content active">

        <section class="gemma-period-filter fade-in-up delay-150">
          <div class="chip-group chip-group-center" id="gemma-period-chips">
            <button type="button" class="chip-toggle" data-gemma-period="today">Today</button>
            <button type="button" class="chip-toggle" data-gemma-period="week">This Week</button>
            <button type="button" class="chip-toggle" data-gemma-period="month">This Month</button>
            <button type="button" class="chip-toggle" data-gemma-period="all">All Time</button>
          </div>
        </section>

        <section class="gemma-stat-grid fade-in-up delay-200" id="gemma-stat-grid">
          <div class="gemma-stat-card" style="--stat-accent:var(--emotion-joy);">
            <div class="stat-icon">
              <i data-lucide="smile" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-joy-count">0</div>
            <div class="stat-label">Joy Detected</div>
            <div class="stat-hint">Updated from analytics</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:var(--emotion-anger);">
            <div class="stat-icon">
              <i data-lucide="frown" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-negative-count">0</div>
            <div class="stat-label">Negative Signals</div>
            <div class="stat-hint">Anger ‚Ä¢ Fear ‚Ä¢ Sadness ‚Ä¢ Disgust</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#7c3aed;">
            <div class="stat-icon">
              <i data-lucide="activity" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-total-analyzed">0</div>
            <div class="stat-label">Total Segments</div>
            <div class="stat-hint" id="gemma-period-label">Selected range</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#38bdf8;">
            <div class="stat-icon">
              <i data-lucide="wind" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-avg-pace">0</div>
            <div class="stat-label">Avg Pace (WPM)</div>
            <div class="stat-hint">Speech overlay</div>
          </div>
          <div class="gemma-stat-card" style="--stat-accent:#fbbf24;">
            <div class="stat-icon">
              <i data-lucide="audio-lines" style="width:18px;height:18px;"></i>
            </div>
            <div class="stat-value" id="gemma-avg-pitch">0</div>
            <div class="stat-label">Avg Pitch (Hz)</div>
            <div class="stat-hint">Speech overlay</div>
          </div>
        </section>

        <section class="glass-card gemma-filter-panel fade-in-up delay-250">
          <div class="gemma-filter-grid">
            <div class="gemma-filter-column">
              <div class="chip-panel-header">
                <h4>Emotion Layers</h4>
                <button type="button" class="chip-toggle chip-all" id="gemma-emotion-all">All</button>
              </div>
              <div class="chip-group" id="gemma-emotion-chips"></div>
            </div>
            <div class="gemma-filter-column">
              <div class="chip-panel-header">
                <h4>Speech Overlays</h4>
                <button type="button" class="chip-toggle chip-all" id="gemma-metric-all">All</button>
              </div>
              <div class="chip-group" id="gemma-metric-chips"></div>
            </div>
          </div>
          <div class="gemma-confidence-control">
            <div class="chip-panel-header">
              <h4>Emotion Confidence Baseline</h4>
              <span id="gemma-confidence-label">70%</span>
            </div>
            <div class="gemma-confidence-slider">
              <input type="range" min="50" max="100" step="5" value="70" id="gemma-confidence-range">
            </div>
            <p class="gemma-confidence-hint">Used whenever transcripts do not include explicit emotion confidence
              scores.
            </p>
          </div>
        </section>

        <!-- Chat Interface removed; use analyzer chat drawer (bottom/overlay) to avoid cramped layout. -->

        <!-- Advanced Analysis Section -->
        <section class="fade-in-up delay-300" style="margin-top: 2rem;">
          <div class="glass-card">
            <div
              style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; cursor: pointer;"
              onclick="toggleAdvancedAnalysis()">
              <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                <i data-lucide="brain" style="width: 24px; height: 24px; color: var(--primary);"></i>
                Advanced Conversation Analysis
              </h3>
              <i data-lucide="chevron-down" id="analysis-toggle-icon"
                style="width: 20px; height: 20px; transition: transform 0.3s;"></i>
            </div>

            <div id="advanced-analysis-content" style="display: block;">
              <p class="text-muted" style="margin-bottom: 1.5rem;">
                Analyze conversations for patterns, fallacies, emotional triggers. Customize the analysis prompt and
                filters.
              </p>
              <div id="gemma-advanced-analyzer"></div>
            </div>
          </div>
      </div>
      </section>

      <!-- Quick Actions -->
      <section class="grid grid-2 fade-in-up delay-300 gemma-quick-actions" style="margin-top: 2rem;">
        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Quick Actions</h4>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-ghost" onclick="quickAnalysis('summary')">
              <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
              Generate Summary
            </button>
            <button class="btn btn-ghost" onclick="quickAnalysis('personality')">
              <i data-lucide="user" style="width: 16px; height: 16px;"></i>
              Analyze Personality
            </button>
            <button class="btn btn-ghost" onclick="quickAnalysis('patterns')">
              <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
              Find Patterns
            </button>
          </div>
        </div>

        <div class="glass-card">
          <h4 style="margin-bottom: 1rem;">Example Questions</h4>
          <div style="color: var(--text-secondary); font-size: 0.875rem; line-height: 1.8;">
            ‚Ä¢ "What were the main topics discussed today?"<br>
            ‚Ä¢ "Analyze the personality of Speaker 1"<br>
            ‚Ä¢ "What emotions dominated this week?"<br>
            ‚Ä¢ "Summarize the last conversation"
          </div>
        </div>
      </section>

    </div><!-- End Analytics Tab -->

    <!-- ============================================ -->
    <!-- Tab Content: Chat                            -->
    <!-- ============================================ -->
    <div id="tab-chat" class="gemma-tab-content">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="message-circle" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Chat with Gemma
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Ask questions about your transcripts, get summaries, or have a conversation with the AI.
        </p>

        <div class="chat-interface">
          <!-- Active Database Indicator -->
          <div id="active-db-indicator" class="active-db-indicator" style="display: none;">
            <i data-lucide="database" style="width: 16px; height: 16px; color: var(--primary);"></i>
            <span class="db-name">No database selected</span>
            <span class="db-badge">RAG Mode</span>
            <button class="btn-clear-db" onclick="clearActiveDatabase()" title="Clear database">√ó</button>
          </div>
          <div class="chat-messages-area" id="chat-messages">
            <div class="chat-message-row">
              <div class="chat-avatar-icon ai-avatar">
                <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
              </div>
              <div class="chat-bubble-content ai-bubble">
                Hello! I'm Gemma, your AI assistant. I can help you analyze conversations, summarize transcripts, detect
                emotions, and answer questions about your data. What would you like to know?
              </div>
            </div>
          </div>

          <div class="chat-input-row">
            <input type="text" id="chat-input" class="glass-input" placeholder="Type your message..." style="flex: 1;">
            <button class="btn btn-primary" onclick="sendChatMessage()">
              <i data-lucide="send" style="width: 18px; height: 18px;"></i>
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Prompts -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Quick Prompts</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <button class="chip-toggle" onclick="useQuickPrompt('Summarize my conversations from today')">üìù Today's
            Summary</button>
          <button class="chip-toggle" onclick="useQuickPrompt('What emotions were most common this week?')">üòä Emotion
            Analysis</button>
          <button class="chip-toggle" onclick="useQuickPrompt('What topics come up most frequently?')">üîç Topic
            Trends</button>
          <button class="chip-toggle" onclick="useQuickPrompt('Analyze the personality traits in my conversations')">üë§
            Personality</button>
        </div>
      </div>
    </div><!-- End Chat Tab -->

    <!-- ============================================ -->
    <!-- Tab Content: Databases                       -->
    <!-- ============================================ -->
    <div id="tab-databases" class="gemma-tab-content">
      <div class="glass-card">
        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="database" style="width: 24px; height: 24px; color: var(--primary);"></i>
          Custom Database Upload
        </h3>
        <p class="text-muted" style="margin-bottom: 1.5rem;">
          Upload CSV files to add custom data for AI analysis. The data will be vectorized and available for RAG
          queries.
        </p>

        <div class="db-upload-zone" id="db-upload-zone" onclick="document.getElementById('db-file-input').click()">
          <i data-lucide="upload-cloud" class="db-upload-icon"></i>
          <h4>Drop CSV files here or click to upload</h4>
          <p class="text-muted" style="margin-top: 0.5rem;">Supports CSV format ‚Ä¢ Max 50MB per file</p>
          <input type="file" id="db-file-input" accept=".csv" multiple style="display: none;"
            onchange="handleDatabaseUpload(event)">
        </div>

        <div class="db-file-list" id="db-file-list">
          <!-- Files will be listed here -->
        </div>
      </div>

      <!-- Existing Databases -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
          <i data-lucide="folder-open" style="width: 20px; height: 20px;"></i>
          Uploaded Databases
        </h4>
        <div id="existing-databases">
          <p class="text-muted">No custom databases uploaded yet.</p>
        </div>
      </div>

      <!-- Database Info -->
      <div class="glass-card" style="margin-top: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">Supported Formats</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <strong>CSV Requirements:</strong>
            <ul style="color: var(--text-secondary); font-size: 0.875rem; padding-left: 1.2rem; margin-top: 0.5rem;">
              <li>UTF-8 encoding</li>
              <li>Header row required</li>
              <li>Comma separated</li>
            </ul>
          </div>
          <div>
            <strong>Coming Soon:</strong>
            <ul style="color: var(--text-muted); font-size: 0.875rem; padding-left: 1.2rem; margin-top: 0.5rem;">
              <li>JSON support</li>
              <li>Excel (.xlsx)</li>
              <li>Parquet files</li>
            </ul>
          </div>
        </div>
      </div>
    </div><!-- End Databases Tab -->

    </div><!-- End gemma-shell -->
  </main>

  <script>
    lucide.createIcons();

    const GEMMA_EMOTION_OPTIONS = [
      { key: 'anger', label: 'Anger', color: 'var(--emotion-anger)' },
      { key: 'fear', label: 'Fear', color: 'var(--emotion-fear)' },
      { key: 'joy', label: 'Joy', color: 'var(--emotion-joy)' },
      { key: 'neutral', label: 'Neutral', color: 'var(--emotion-neutral)' },
      { key: 'sadness', label: 'Sadness', color: 'var(--emotion-sadness)' },
      { key: 'surprise', label: 'Surprise', color: 'var(--emotion-surprise)' },
      { key: 'disgust', label: 'Disgust', color: 'var(--emotion-disgust)' },
    ];

    const GEMMA_METRIC_OPTIONS = [
      { key: 'pace_wpm', label: 'Pace', color: '#38bdf8' },
      { key: 'pitch_mean', label: 'Pitch', color: '#fbbf24' },
      { key: 'volume_rms', label: 'Volume', color: '#f472b6' },
      { key: 'volume_peak', label: 'Volume Peak', color: '#fb7185' },
      { key: 'pause_ms', label: 'Pauses', color: '#14b8a6' },
      { key: 'word_count', label: 'Words', color: '#facc15' },
    ];

    const GEMMA_PERIOD_LOOKBACK = { today: 0, week: 6, month: 29, all: null };
    const GEMMA_PERIOD_LABELS = { today: 'Today', week: 'This Week', month: 'This Month', all: 'All Time' };

    const gemmaInsightsState = {
      period: 'all',
      selectedEmotions: new Set(GEMMA_EMOTION_OPTIONS.map((opt) => opt.key)),
      selectedMetrics: new Set(GEMMA_METRIC_OPTIONS.map((opt) => opt.key)),
      analytics: null,
      loading: false,
    };

    // ================================================
    // Database State Management (RAG Chatbot)
    // ================================================
    let activeDatabase = null;  // {filename, displayName, columns, isReady}

    function setActiveDatabase(db) {
      activeDatabase = db;

      // Persist to localStorage for session persistence
      if (db) {
        localStorage.setItem('nemo_active_database', JSON.stringify({
          filename: db.filename,
          displayName: db.displayName,
          columns: db.columns || [],
          isReady: db.isReady
        }));
      } else {
        localStorage.removeItem('nemo_active_database');
      }

      updateDatabaseIndicator();
    }

    function clearActiveDatabase() {
      setActiveDatabase(null);
      addChatMessage('üìä Database cleared. I\'ll respond with general knowledge now.', 'ai');
    }

    function updateDatabaseIndicator() {
      const indicator = document.getElementById('active-db-indicator');
      if (!indicator) return;

      if (activeDatabase && activeDatabase.isReady) {
        indicator.style.display = 'flex';
        indicator.querySelector('.db-name').textContent = activeDatabase.displayName;
        lucide.createIcons();
      } else {
        indicator.style.display = 'none';
      }

      // Also refresh the databases list to show active state
      loadSavedDatabases();
    }

    async function restoreActiveDatabase() {
      const saved = localStorage.getItem('nemo_active_database');
      if (saved) {
        try {
          const db = JSON.parse(saved);

          // Verify the database still exists on server
          const response = await fetch('/databases', { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            const exists = data.databases.find(d => d.filename === db.filename);

            if (exists && exists.has_embeddings) {
              activeDatabase = { ...db, isReady: true };
              updateDatabaseIndicator();
              return;
            }
          }
        } catch (e) {
          console.warn('Could not restore database session:', e);
        }

        // Clear invalid saved state
        localStorage.removeItem('nemo_active_database');
      }
    }

    const numberFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
    const GEMMA_DEFAULT_CONFIDENCE = getDefaultConfidencePercent();
    let gemmaConfidencePercent = GEMMA_DEFAULT_CONFIDENCE;
    let gemmaConfidenceSlider;
    let gemmaConfidenceLabel;

    function getDefaultConfidencePercent() {
      try {
        if (typeof window !== 'undefined' && typeof window.getEmotionConfidenceBaseline === 'function') {
          return Math.round(window.getEmotionConfidenceBaseline() * 100);
        }
      } catch (_) {
        /* noop */
      }
      return 70;
    }

    function initGemmaControls() {
      renderGemmaEmotionChips();
      renderGemmaMetricChips();
      bindGemmaPeriodChips();
      const emotionAllBtn = document.getElementById('gemma-emotion-all');
      if (emotionAllBtn) {
        emotionAllBtn.onclick = () => {
          gemmaInsightsState.selectedEmotions = new Set(GEMMA_EMOTION_OPTIONS.map((opt) => opt.key));
          renderGemmaEmotionChips();
          syncAnalyzerEmotionsFromState();
          refreshGemmaAnalytics();
        };
      }
      const metricAllBtn = document.getElementById('gemma-metric-all');
      if (metricAllBtn) {
        metricAllBtn.onclick = () => {
          gemmaInsightsState.selectedMetrics = new Set(GEMMA_METRIC_OPTIONS.map((opt) => opt.key));
          renderGemmaMetricChips();
          refreshGemmaAnalytics();
        };
      }
      initGemmaConfidenceControl();
      syncAnalyzerEmotionsFromState();
      return setGemmaPeriod('all', { force: true });
    }

    function renderGemmaEmotionChips() {
      const container = document.getElementById('gemma-emotion-chips');
      if (!container) return;
      container.innerHTML = GEMMA_EMOTION_OPTIONS.map((opt) => {
        const active = gemmaInsightsState.selectedEmotions.has(opt.key);
        return `
          <button type="button" class="chip-toggle" data-emotion="${opt.key}" aria-pressed="${active}" style="--chip-color:${opt.color};">
            ${opt.label}
          </button>
        `;
      }).join('');
      container.querySelectorAll('button[data-emotion]').forEach((btn) => {
        btn.addEventListener('click', () => toggleGemmaEmotion(btn.dataset.emotion));
      });
    }

    function renderGemmaMetricChips() {
      const container = document.getElementById('gemma-metric-chips');
      if (!container) return;
      container.innerHTML = GEMMA_METRIC_OPTIONS.map((opt) => {
        const active = gemmaInsightsState.selectedMetrics.has(opt.key);
        return `
          <button type="button" class="chip-toggle" data-metric="${opt.key}" aria-pressed="${active}" style="--chip-color:${opt.color};">
            ${opt.label}
          </button>
        `;
      }).join('');
      container.querySelectorAll('button[data-metric]').forEach((btn) => {
        btn.addEventListener('click', () => toggleGemmaMetric(btn.dataset.metric));
      });
    }

    function initGemmaConfidenceControl() {
      gemmaConfidenceSlider = document.getElementById('gemma-confidence-range');
      gemmaConfidenceLabel = document.getElementById('gemma-confidence-label');
      if (!gemmaConfidenceSlider || !gemmaConfidenceLabel) return;
      gemmaConfidenceSlider.value = gemmaConfidencePercent;
      gemmaConfidenceLabel.textContent = `${gemmaConfidencePercent}%`;
      gemmaConfidenceSlider.addEventListener('input', (event) => {
        gemmaConfidencePercent = Number(event.target.value);
        gemmaConfidenceLabel.textContent = `${gemmaConfidencePercent}%`;
        syncAnalyzerConfidence(gemmaConfidencePercent);
      });
      syncAnalyzerConfidence(gemmaConfidencePercent);
    }

    function syncAnalyzerEmotionsFromState() {
      if (typeof window === 'undefined' || typeof window.dispatchEvent !== 'function') return;
      const payload = Array.from(gemmaInsightsState.selectedEmotions || []);
      window.dispatchEvent(new CustomEvent('gemmaEmotionFiltersChanged', { detail: payload }));
    }

    function toggleGemmaEmotion(emotion) {
      if (!emotion) return;
      const set = gemmaInsightsState.selectedEmotions;
      if (set.has(emotion)) {
        set.delete(emotion);
      } else {
        set.add(emotion);
      }
      if (!set.size) {
        GEMMA_EMOTION_OPTIONS.forEach((opt) => set.add(opt.key));
      }
      renderGemmaEmotionChips();
      syncAnalyzerEmotionsFromState();
      refreshGemmaAnalytics();
    }

    function toggleGemmaMetric(metric) {
      if (!metric) return;
      const set = gemmaInsightsState.selectedMetrics;
      if (set.has(metric)) {
        set.delete(metric);
      } else {
        set.add(metric);
      }
      if (!set.size) {
        GEMMA_METRIC_OPTIONS.forEach((opt) => set.add(opt.key));
      }
      renderGemmaMetricChips();
      refreshGemmaAnalytics();
    }

    function bindGemmaPeriodChips() {
      document.querySelectorAll('[data-gemma-period]').forEach((btn) => {
        btn.addEventListener('click', () => setGemmaPeriod(btn.dataset.gemmaPeriod));
      });
    }

    function setGemmaPeriod(period, { force = false } = {}) {
      if (!period) return;
      if (!force && gemmaInsightsState.period === period) return;
      gemmaInsightsState.period = period;
      document.querySelectorAll('[data-gemma-period]').forEach((btn) => {
        const isActive = btn.dataset.gemmaPeriod === period;
        btn.setAttribute('aria-pressed', isActive);
        btn.classList.toggle('active', isActive);
      });
      return refreshGemmaAnalytics();
    }

    function setGemmaInsightsLoading(isLoading) {
      const grid = document.getElementById('gemma-stat-grid');
      gemmaInsightsState.loading = isLoading;
      if (grid) grid.classList.toggle('loading', !!isLoading);
    }

    function computeGemmaPeriodRange(period) {
      if (period === 'all') {
        return { start: null, end: null };
      }
      const lookback = GEMMA_PERIOD_LOOKBACK[period] ?? 6;
      const now = new Date();
      const end = now.toISOString().slice(0, 10);
      const startDate = new Date(now);
      startDate.setDate(startDate.getDate() - lookback);
      const start = startDate.toISOString().slice(0, 10);
      return { start, end };
    }

    async function refreshGemmaAnalytics() {
      setGemmaInsightsLoading(true);
      const { start, end } = computeGemmaPeriodRange(gemmaInsightsState.period);
      try {
        const payload = await api.getAnalyticsSignals({
          start_date: start || undefined,
          end_date: end || undefined,
          emotions: Array.from(gemmaInsightsState.selectedEmotions),
          metrics: Array.from(gemmaInsightsState.selectedMetrics),
        });
        gemmaInsightsState.analytics = payload;
        renderGemmaStatCards(payload?.summary || {});
      } catch (error) {
        console.error('[Gemma] Failed to load analytics signals', error);
        renderGemmaStatCards(null);
      } finally {
        setGemmaInsightsLoading(false);
      }
    }

    function renderGemmaStatCards(summary) {
      if (!summary) {
        setTextContent('gemma-joy-count', '‚Äî');
        setTextContent('gemma-negative-count', '‚Äî');
        setTextContent('gemma-total-analyzed', '‚Äî');
        setTextContent('gemma-avg-pace', '‚Äî');
        setTextContent('gemma-avg-pitch', '‚Äî');
        const label = document.getElementById('gemma-period-label');
        if (label) {
          const name = GEMMA_PERIOD_LABELS[gemmaInsightsState.period] || 'Selected';
          label.textContent = `${name} window`;
        }
        return;
      }
      const totals = summary?.emotion_totals || {};
      const joy = totals.joy ?? 0;
      const negative = (totals.anger || 0) + (totals.fear || 0) + (totals.sadness || 0) + (totals.disgust || 0);
      const totalAnalyzed = summary?.total_analyzed ?? 0;
      const avgPace = summary?.avg_pace_wpm ?? null;
      const avgPitch = summary?.avg_pitch_mean ?? null;

      setTextContent('gemma-joy-count', formatBigNumber(joy));
      setTextContent('gemma-negative-count', formatBigNumber(negative));
      setTextContent('gemma-total-analyzed', formatBigNumber(totalAnalyzed));
      setTextContent('gemma-avg-pace', formatMetricValue(avgPace));
      setTextContent('gemma-avg-pitch', formatMetricValue(avgPitch));

      const label = document.getElementById('gemma-period-label');
      if (label) {
        const name = GEMMA_PERIOD_LABELS[gemmaInsightsState.period] || 'Selected';
        label.textContent = `${name} window`;
      }
    }

    function setTextContent(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatBigNumber(value) {
      if (value === null || value === undefined) return '‚Äî';
      const num = Number(value);
      if (!Number.isFinite(num)) return '‚Äî';
      return numberFormatter.format(Math.round(num));
    }

    function formatMetricValue(value) {
      if (value === null || value === undefined) return '‚Äî';
      const num = Number(value);
      if (!Number.isFinite(num)) return '‚Äî';
      return Math.round(num);
    }

    function syncAnalyzerConfidence(percent) {
      const analyzerRoot = document.querySelector('#gemma-advanced-analyzer');
      if (!analyzerRoot || percent === null || percent === undefined) return;
      const slider = analyzerRoot.querySelector('[data-role="emotion-confidence-range"]');
      const label = analyzerRoot.querySelector('[data-role="emotion-confidence-label"]');
      if (slider) slider.value = percent;
      if (label) label.textContent = `${percent}%`;
      analyzerRoot.querySelectorAll('[data-role="emotion-pill"]').forEach((pill) => {
        if (pill) pill.textContent = `${percent}%`;
      });
    }

    // Quick Actions -> Advanced Analyzer (prompt + run quick)
    async function quickAnalysis(type) {
      const prompts = {
        summary: 'Summarize the most important points from recent conversations.',
        personality: 'Analyze the personality traits shown in recent discussions.',
        patterns: 'What communication patterns have emerged lately?',
      };
      try {
        if (typeof toggleAdvancedAnalysis === 'function') {
          const content = document.getElementById('advanced-analysis-content');
          if (content && content.style.display === 'none') {
            toggleAdvancedAnalysis();
          }
        }
        const mount = document.querySelector('#gemma-advanced-analyzer');
        if (!mount) return;
        const promptEl = mount.querySelector('textarea[data-role="prompt"]');
        const runQuickBtn = mount.querySelector('button[data-role="run-quick"]');
        if (promptEl) promptEl.value = prompts[type] || prompts.summary;
        if (runQuickBtn) runQuickBtn.click();
      } catch (e) {
        console.warn('Quick action failed', e);
      }
    }
    window.quickAnalysis = quickAnalysis;
    async function loadGPUStats() {
      try {
        const stats = await api.getGemmaStats();
        console.debug('[GEMMA] Stats', stats);
        if (!stats) return;

        if (stats.model_on_gpu !== undefined) {
          document.getElementById('inference-speed').textContent = stats.model_on_gpu ? '~30 tok/s' : '~10 tok/s (CPU)';
        }

        if (stats.vram_used_mb !== undefined && stats.vram_total_mb) {
          const used = Math.round(stats.vram_used_mb / 1024 * 10) / 10;
          const total = Math.round(stats.vram_total_mb / 1024 * 10) / 10;
          document.getElementById('gpu-memory').textContent = `${used} / ${total} GB`;
        }
      } catch (error) {
        console.error('Failed to load GPU stats:', error);
      }
    }

    // Initialize page with authentication
    async function initPage() {
      // Enforce authentication
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;

      // Load GPU stats
      await loadGPUStats();

      await initGemmaControls();

      // Make sure the analyzer is ready without extra clicks
      ensureAdvancedAnalysisReady();
    }
    // ========================================================================
    // ADVANCED ANALYSIS
    // ========================================================================

    let advancedAnalyzerInstance = null;

    function ensureAdvancedAnalysisReady() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      if (content) {
        content.style.display = 'block';
      }
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
      if (typeof initGemmaAnalyzer === 'function') {
        if (!advancedAnalyzerInstance) {
          advancedAnalyzerInstance = initGemmaAnalyzer({ mount: '#gemma-advanced-analyzer' });
        } else if (advancedAnalyzerInstance.refreshCount) {
          advancedAnalyzerInstance.refreshCount();
        }
      }
      syncAnalyzerConfidence(gemmaConfidencePercent);
      syncAnalyzerEmotionsFromState();
    }

    function toggleAdvancedAnalysis() {
      const content = document.getElementById('advanced-analysis-content');
      const icon = document.getElementById('analysis-toggle-icon');
      const isHidden = content.style.display === 'none';

      content.style.display = isHidden ? 'block' : 'none';
      icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

      if (isHidden) {
        ensureAdvancedAnalysisReady();
      }

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    window.toggleAdvancedAnalysis = toggleAdvancedAnalysis;

    // ================================================
    // Tab Switching
    // ================================================
    function initTabs() {
      const tabs = document.querySelectorAll('.gemma-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.gemma-tab');
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Update tab content
      const contents = document.querySelectorAll('.gemma-tab-content');
      contents.forEach(content => {
        const shouldBeActive = content.id === `tab-${tabName}`;
        content.classList.toggle('active', shouldBeActive);
      });

      // Re-render icons for the new tab
      if (window.lucide && window.lucide.createIcons) {
        setTimeout(() => window.lucide.createIcons(), 50);
      }
    }

    // ================================================
    // Chat Functionality
    // ================================================

    // Conversation history for context (limited to avoid token overflow)
    const chatHistory = [];
    const MAX_HISTORY = 6; // Keep last 6 messages (3 exchanges) to stay under 8k context

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addChatMessage(message, 'user');

      // Add to history for general chat mode
      chatHistory.push({ role: 'user', content: message });

      // Trim history if too long to prevent OOM
      while (chatHistory.length > MAX_HISTORY) {
        chatHistory.shift();
      }

      // Show thinking indicator
      const thinkingId = addThinkingIndicator();

      try {
        let response, aiResponse;

        if (activeDatabase && activeDatabase.isReady) {
          // ========================================
          // RAG MODE: Query the active database
          // ========================================
          response = await fetch('/ask', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filename: activeDatabase.filename,
              question: message
            })
          });

          if (response.ok) {
            const data = await response.json();
            aiResponse = data.answer || 'I couldn\'t find relevant information in the database.';

            // Add source context if available
            if (data.context && data.context.length > 0) {
              aiResponse += `\n\nüìã *Based on: ${activeDatabase.displayName}*`;
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            aiResponse = `Sorry, I couldn't query the database: ${errorData.detail || 'Unknown error'}`;
          }
        } else {
          // ========================================
          // GENERAL CHAT MODE: No database context
          // ========================================
          response = await fetch('/api/public/chat', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: chatHistory,
              max_tokens: 500,
              temperature: 0.7,
              top_p: 0.9
            })
          });

          if (response.ok) {
            const data = await response.json();
            aiResponse = data.message || data.text || 'I received your message but had trouble generating a response.';

            // Add AI response to history
            chatHistory.push({ role: 'assistant', content: aiResponse });

            // Trim again after adding response
            while (chatHistory.length > MAX_HISTORY) {
              chatHistory.shift();
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg = errorData.detail || errorData.message || `Error ${response.status}`;
            aiResponse = `Sorry, I encountered an error: ${errorMsg}`;
          }
        }

        removeThinkingIndicator(thinkingId);
        addChatMessage(aiResponse, 'ai');

      } catch (error) {
        console.error('Chat error:', error);
        removeThinkingIndicator(thinkingId);
        addChatMessage('Connection error. Please check your connection and try again.', 'ai');
      }
    }

    function addThinkingIndicator() {
      const container = document.getElementById('chat-messages');
      const id = 'thinking-' + Date.now();
      const html = `
        <div id="${id}" class="chat-message-row">
          <div class="chat-avatar-icon ai-avatar">
            <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
          </div>
          <div class="chat-bubble-content ai-bubble">
            <div class="thinking-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
      container.scrollTop = container.scrollHeight;
      lucide.createIcons();
      return id;
    }

    function removeThinkingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function addChatMessage(text, sender) {
      const container = document.getElementById('chat-messages');
      const isUser = sender === 'user';

      // Simple markdown renderer for AI messages
      let formattedText = text;
      if (!isUser) {
        formattedText = renderMarkdown(text);
      }

      const messageHtml = `
        <div class="chat-message-row ${isUser ? 'user' : ''}">
          ${!isUser ? `
            <div class="chat-avatar-icon ai-avatar">
              <i data-lucide="bot" style="width: 18px; height: 18px; color: white;"></i>
            </div>
          ` : ''}
          <div class="chat-bubble-content ${isUser ? 'user-bubble' : 'ai-bubble'}">
            ${formattedText}
          </div>
          ${isUser ? `
            <div class="chat-avatar-icon user-avatar">
              <i data-lucide="user" style="width: 18px; height: 18px; color: white;"></i>
            </div>
          ` : ''}
        </div>
      `;

      container.insertAdjacentHTML('beforeend', messageHtml);
      container.scrollTop = container.scrollHeight;

      if (window.lucide && window.lucide.createIcons) {
        window.lucide.createIcons();
      }
    }

    function renderMarkdown(text) {
      // Escape HTML first
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Headers (## and ###)
      html = html.replace(/^### (.+)$/gm, '<h4 style="margin: 0.8em 0 0.4em; color: #a78bfa; font-size: 0.95em;">$1</h4>');
      html = html.replace(/^## (.+)$/gm, '<h3 style="margin: 1em 0 0.5em; color: #c4b5fd; font-size: 1.05em;">$1</h3>');

      // Bold (**text** or __text__)
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #e0d4ff;">$1</strong>');
      html = html.replace(/__([^_]+)__/g, '<strong style="color: #e0d4ff;">$1</strong>');

      // Italic (*text* or _text_)
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

      // Bullet points (* or -)
      html = html.replace(/^\s*[\*\-]\s+(.+)$/gm, '<li style="margin: 0.3em 0; padding-left: 0.5em;">$1</li>');

      // Wrap consecutive <li> in <ul>
      html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/g, (match) => {
        return `<ul style="margin: 0.5em 0; padding-left: 1.2em; list-style-type: disc;">${match}</ul>`;
      });

      // Numbers (1. 2. etc)
      html = html.replace(/^\s*(\d+)\.\s+(.+)$/gm, '<li style="margin: 0.3em 0;">$2</li>');

      // Code inline (`code`)
      html = html.replace(/`([^`]+)`/g, '<code style="background: rgba(139, 92, 246, 0.2); padding: 0.1em 0.4em; border-radius: 4px; font-size: 0.9em;">$1</code>');

      // Line breaks (double newline = paragraph, single = br)
      html = html.replace(/\n\n+/g, '</p><p style="margin: 0.8em 0;">');
      html = html.replace(/\n/g, '<br>');

      // Wrap in paragraph
      html = `<div style="line-height: 1.6;">${html}</div>`;

      return html;
    }

    function useQuickPrompt(prompt) {
      document.getElementById('chat-input').value = prompt;
      sendChatMessage();
    }

    // Chat input enter key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement.id === 'chat-input') {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // ================================================
    // Database Upload
    // ================================================
    function initDatabaseUpload() {
      const dropZone = document.getElementById('db-upload-zone');
      if (!dropZone) return;

      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
        if (files.length > 0) {
          processUploadedFiles(files);
        }
      });
    }

    function handleDatabaseUpload(event) {
      const files = Array.from(event.target.files).filter(f => f.name.endsWith('.csv'));
      if (files.length > 0) {
        processUploadedFiles(files);
      }
    }

    async function processUploadedFiles(files) {
      const listContainer = document.getElementById('db-file-list');

      for (const file of files) {
        // Add file to list with pending status
        const fileId = `file-${Date.now()}`;
        const fileHtml = `
          <div class="db-file-item" id="${fileId}">
            <div class="db-file-info">
              <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
              <div>
                <div style="font-weight: 500;">${file.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</div>
              </div>
            </div>
            <span class="db-file-status pending">Pending</span>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', fileHtml);
        if (window.lucide) window.lucide.createIcons();

        const statusEl = document.querySelector(`#${fileId} .db-file-status`);

        try {
          // Step 1: Upload file
          statusEl.textContent = 'Uploading...';
          statusEl.className = 'db-file-status processing';

          const formData = new FormData();
          formData.append('file', file);

          const uploadResponse = await fetch('/upload', {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });

          const uploadData = await uploadResponse.json();

          if (!uploadResponse.ok || !uploadData.filename) {
            throw new Error(uploadData.detail || 'Upload failed');
          }

          // Step 2: Run full ML analysis (this caches insights for Q&A)
          statusEl.textContent = 'Running ML analysis...';

          try {
            const analyzeResponse = await fetch(`/analyze-full/${uploadData.filename}`, {
              method: 'POST',
              credentials: 'include'
            });

            if (analyzeResponse.ok) {
              const analyzeData = await analyzeResponse.json();
              console.log('‚úÖ Full analysis complete:', analyzeData.analyses_run);
              statusEl.textContent = 'Analysis complete...';
            } else {
              console.warn('Full analysis failed, will use basic mode');
            }
          } catch (analyzeError) {
            console.warn('Analysis error (non-fatal):', analyzeError);
          }

          // Step 3: Create embeddings for semantic search (optional, runs in background)
          statusEl.textContent = 'Creating search index...';

          fetch('/embed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ filename: uploadData.filename })
          }).then(r => {
            if (!r.ok) console.warn('Embedding creation failed, will use cached analysis');
          }).catch(e => console.warn('Embedding error:', e));

          // Step 4: Set as active database
          setActiveDatabase({
            filename: uploadData.filename,
            displayName: file.name,
            columns: uploadData.columns || [],
            isReady: true
          });

          statusEl.textContent = '‚úÖ Ready';
          statusEl.className = 'db-file-status complete';

          // Show success message in chat
          switchTab('chat');
          addChatMessage(`üìä Database "${file.name}" analyzed and ready! Ask me anything about your data - I've already analyzed the distributions, correlations, and anomalies.`, 'ai');

        } catch (error) {
          console.error('Upload error:', error);
          statusEl.textContent = `Error: ${error.message}`;
          statusEl.className = 'db-file-status pending';
        }
      }
    }

    // ================================================
    // Saved Databases Management
    // ================================================
    async function loadSavedDatabases() {
      const container = document.getElementById('existing-databases');
      if (!container) return;

      try {
        const response = await fetch('/databases', { credentials: 'include' });
        if (!response.ok) {
          container.innerHTML = '<p class="text-muted">Could not load databases.</p>';
          return;
        }

        const data = await response.json();

        if (!data.databases || data.databases.length === 0) {
          container.innerHTML = '<p class="text-muted">No databases uploaded yet. Upload a CSV to get started!</p>';
          return;
        }

        container.innerHTML = `
          <div class="saved-db-list">
            ${data.databases.map(db => `
              <div class="saved-db-item ${activeDatabase?.filename === db.filename ? 'active' : ''}">
                <div class="db-info">
                  <i data-lucide="${db.has_embeddings ? 'database' : 'file'}" style="width: 18px; height: 18px; color: ${db.has_embeddings ? 'var(--primary)' : 'var(--text-muted)'};"></i>
                  <div>
                    <div class="db-name">${db.display_name}</div>
                    <div class="db-meta">${(db.size_bytes / 1024).toFixed(1)} KB ${db.has_embeddings ? '‚Ä¢ Indexed' : ''}</div>
                  </div>
                </div>
                <div class="db-actions">
                  ${db.has_embeddings
            ? `<button class="btn-use" onclick="selectDatabase('${db.filename}', '${db.display_name.replace(/'/g, "\\'")}')">
                         ${activeDatabase?.filename === db.filename ? '‚úì Active' : 'Use'}
                       </button>`
            : `<button class="btn-embed" onclick="embedDatabase('${db.filename}', this)">Index</button>`
          }
                </div>
              </div>
            `).join('')}
          </div>
        `;

        lucide.createIcons();

      } catch (error) {
        console.error('Error loading databases:', error);
        container.innerHTML = '<p class="text-muted">Error loading databases.</p>';
      }
    }

    function selectDatabase(filename, displayName) {
      setActiveDatabase({
        filename,
        displayName,
        columns: [],
        isReady: true
      });

      // Notify user and switch to chat
      switchTab('chat');
      addChatMessage(`üìä Switched to database "${displayName}". Ask me anything about it!`, 'ai');
    }

    async function embedDatabase(filename, buttonEl) {
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Indexing...';
      }

      try {
        const response = await fetch('/embed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ filename })
        });

        if (response.ok) {
          loadSavedDatabases(); // Refresh list
        } else {
          const data = await response.json().catch(() => ({}));
          alert(`Failed to create index: ${data.detail || 'Unknown error'}`);
          if (buttonEl) {
            buttonEl.disabled = false;
            buttonEl.textContent = 'Index';
          }
        }
      } catch (error) {
        console.error('Embed error:', error);
        alert('Failed to create index. Please try again.');
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = 'Index';
        }
      }
    }

    // Make functions available globally
    window.sendChatMessage = sendChatMessage;
    window.useQuickPrompt = useQuickPrompt;
    window.handleDatabaseUpload = handleDatabaseUpload;
    window.selectDatabase = selectDatabase;
    window.embedDatabase = embedDatabase;
    window.clearActiveDatabase = clearActiveDatabase;

    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        initPage();
        initTabs();
        initDatabaseUpload();
        await restoreActiveDatabase();
        loadSavedDatabases();
      });
    } else {
      initPage();
      initTabs();
      initDatabaseUpload();
      restoreActiveDatabase().then(() => loadSavedDatabases());
    }
  </script>

</body>

</html>