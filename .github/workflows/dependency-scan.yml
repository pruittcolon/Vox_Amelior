# Dependency Scanning Workflow
# Phase 18 of ultimateseniordevplan.md
#
# This workflow scans Python dependencies for known vulnerabilities
# and blocks merges if critical issues are found.

name: Dependency Security Scan

on:
  pull_request:
    paths:
      - "**/requirements*.txt"
      - "**/pyproject.toml"
      - "**/poetry.lock"
  push:
    branches: [main]
  schedule:
    # Run daily at 2am UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  pip-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - services/api-gateway
          - services/gemma-service
          - services/transcription-service
          - services/ml-service
          - shared

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          cd ${{ matrix.service }}
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt --desc on --format json > audit-results.json || true
            pip-audit -r requirements.txt --desc on || exit 1
          fi
        continue-on-error: false

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-${{ matrix.service }}
          path: ${{ matrix.service }}/audit-results.json

  safety-check:
    name: Safety Vulnerability Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install safety
        run: pip install safety

      - name: Run safety check
        run: |
          # Aggregate all requirements files
          find . -name "requirements*.txt" -exec cat {} \; > all-requirements.txt
          safety check -r all-requirements.txt --full-report || exit 1

  trivy-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build test images
        run: |
          docker compose -f docker/docker-compose.yml build api-gateway

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "refactored-gateway:latest"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

  summarize:
    name: Summary
    runs-on: ubuntu-latest
    needs: [pip-audit, safety-check]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.pip-audit.result }}" == "failure" ] || \
             [ "${{ needs.safety-check.result }}" == "failure" ]; then
            echo "::error::Dependency vulnerabilities found!"
            exit 1
          fi
          echo "âœ… All dependency scans passed"
