# Remote Server Configuration - No GPU Required
# Use this on a laptop without NVIDIA GPU (e.g., Intel integrated graphics)
#
# Usage:
#   1. Copy this repo to your remote laptop
#   2. Edit REMOTE_SERVER_IP below to match your laptop's WiFi IP
#   3. Run: docker compose -f docker-compose.remote.yml up -d
#   4. Access from main PC: http://<REMOTE_SERVER_IP>:8000/ui/login.html
#
# Services EXCLUDED (require NVIDIA GPU):
#   - gemma-service (LLM inference)
#   - transcription-service (speech-to-text with GPU acceleration)
#
# Services INCLUDED (CPU-only):
#   - api-gateway, rag-service, emotion-service, insights-service
#   - ml-service, fiserv-service, n8n-service
#   - redis, postgres

x-remote-ip: &remote-ip "0.0.0.0" # Listen on all interfaces for WiFi access

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  redis:
    image: redis:7-alpine
    container_name: nemo_remote_redis
    restart: unless-stopped
    command: >
      sh -c "redis-server --requirepass $$(cat /run/secrets/redis_password)"
    ports:
      - "127.0.0.1:6379:6379" # Keep local-only for security
    volumes:
      - redis_data:/data
    secrets:
      - redis_password
    healthcheck:
      test: [ "CMD", "sh", "-c", "redis-cli -a $$(cat /run/secrets/redis_password) ping 2>/dev/null | grep PONG" ]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - nemo_remote_network

  postgres:
    image: postgres:15-alpine
    container_name: nemo_remote_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: nemo_queue
      POSTGRES_USER_FILE: /run/secrets/postgres_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    secrets:
      - postgres_user
      - postgres_password
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$(cat /run/secrets/postgres_user)" ]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - nemo_remote_network

  # ============================================================================
  # API Gateway (Frontend & Authentication) - NETWORK ACCESSIBLE
  # ============================================================================

  api-gateway:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gateway
    image: refactored-gateway:latest
    container_name: nemo_remote_gateway
    restart: unless-stopped
    environment:
      # Point to LOCAL services (no GPU services available)
      RAG_URL: http://rag-service:8004
      EMOTION_URL: http://emotion-service:8005
      INSIGHTS_URL: http://insights-service:8010
      ML_SERVICE_URL: http://ml-service:8006
      FISERV_SERVICE_URL: http://fiserv-service:8015
      # DISABLED - No GPU services on remote server
      GEMMA_URL: ""
      TRANSCRIPTION_URL: ""
      # Rate limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_DEFAULT: "1000"
      RATE_LIMIT_WINDOW_SEC: "60"
      # Demo users for testing
      ENABLE_DEMO_USERS: "${ENABLE_DEMO_USERS:-true}"
      SECURE_MODE: "${SECURE_MODE:-false}"
      # CORS: Allow your main PC's IP (update this!)
      ALLOWED_ORIGINS: "http://127.0.0.1,http://localhost,http://192.168.0.0/16"
      # Security settings for local network
      SESSION_COOKIE_SECURE: "false" # No HTTPS on local network
      SESSION_COOKIE_SAMESITE: "lax"
      FORCE_HSTS: "false"
      CANONICAL_HOST: ""
      LOGIN_RATE_LIMIT_WINDOW: "60"
      LOGIN_RATE_LIMIT_LIMIT: "1000"
      ALLOW_FRAMING: "false"
      # Salesforce CRM Integration
      SALESFORCE_CLIENT_ID: "${SALESFORCE_CLIENT_ID:-}"
      SALESFORCE_CLIENT_SECRET: "${SALESFORCE_CLIENT_SECRET:-}"
      SALESFORCE_DOMAIN: "${SALESFORCE_DOMAIN:-}"
      SALESFORCE_API_VERSION: "${SALESFORCE_API_VERSION:-v59.0}"
      SALESFORCE_ENABLED: "${SALESFORCE_ENABLED:-true}"
    volumes:
      - ./gateway_instance:/app/instance
      - ../frontend:/app/frontend:ro
      - ../services/api-gateway/src:/app/src:ro
      - ../shared:/app/shared:ro
      - ml_uploads:/app/data/uploads
    secrets:
      - session_key
      - users_db_key
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # NETWORK ACCESSIBLE - Listen on all interfaces
    ports:
      - "0.0.0.0:8000:8000"
    depends_on:
      rag-service:
        condition: service_healthy
      emotion-service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nemo_remote_network

  # ============================================================================
  # RAG Service (Memory & Vector Search) - CPU Only
  # ============================================================================

  rag-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.rag
    image: refactored-rag-service:latest
    container_name: nemo_remote_rag
    restart: unless-stopped
    environment:
      EMBEDDING_MODEL: "sentence-transformers/all-MiniLM-L6-v2"
      DB_PATH: "/app/instance/rag.db"
      FAISS_INDEX_PATH: "/app/faiss_index/index.bin"
      HF_HOME: "/app/models"
      JWT_ONLY: "true"
      EMAIL_ANALYZER_ENABLED: "true"
      EMAIL_DB_ENCRYPTION: "true"
      EMAIL_DB_KEY_FILE: /run/secrets/email_db_key
      EMAIL_DB_PATH: /app/instance/email.db
    volumes:
      - ./rag_instance:/app/instance
      - ./faiss_index:/app/faiss_index
      - ../models:/app/models
      - ../shared:/app/shared
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
      - rag_db_key
      - email_db_key
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8004/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nemo_remote_network

  # ============================================================================
  # Insights / Analytics Service - CPU Only
  # ============================================================================

  insights-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.insights
    container_name: nemo_remote_insights
    restart: unless-stopped
    environment:
      INSIGHTS_DB_PATH: /app/instance/rag.db
    volumes:
      - ./rag_instance:/app/instance
      - ../shared:/app/shared
    secrets:
      - rag_db_key
    depends_on:
      rag-service:
        condition: service_healthy
    networks:
      - nemo_remote_network

  # ============================================================================
  # Emotion Service (Sentiment Analysis) - CPU Only
  # ============================================================================

  emotion-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.emotion
    image: refactored-emotion-service:latest
    container_name: nemo_remote_emotion
    restart: unless-stopped
    environment:
      EMOTION_MODEL_PATH: "/app/models/emotion-english-distilroberta-base"
      JWT_ONLY: "true"
    volumes:
      - ../models:/app/models:ro
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; r = requests.get('http://localhost:8005/health'); exit(0 if r.json().get('status') == 'healthy' and r.json().get('classifier_loaded') else 1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - nemo_remote_network

  # ============================================================================
  # ML Service (Universal ML Agent) - CPU Only
  # ============================================================================

  ml-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ml
    container_name: nemo_remote_ml
    restart: unless-stopped
    environment:
      GATEWAY_URL: http://api-gateway:8000
      UPLOAD_DIR: /app/data/uploads
      GPU_ENABLED: "false"
      GPU_FALLBACK_TO_CPU: "true"
    volumes:
      - ../services/ml-service/src:/app/src
      - ../shared:/app/shared
      - ml_uploads:/app/data/uploads
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8006/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nemo_remote_network

  # ============================================================================
  # Fiserv Banking Hub Service - CPU Only
  # ============================================================================

  fiserv-service:
    build:
      context: ../services/fiserv-service
      dockerfile: Dockerfile
    container_name: nemo_remote_fiserv
    restart: unless-stopped
    environment:
      FISERV_MOCK_MODE: "false"
      # Phase 1 Security: Load credentials from Docker secrets
      FISERV_API_KEY_FILE: /run/secrets/fiserv_api_key
      FISERV_API_SECRET_FILE: /run/secrets/fiserv_api_secret
      FISERV_ORG_ID: "999950001"
      PYTHONUNBUFFERED: "1"
      JWT_ONLY: "true"
    volumes:
      - ../services/fiserv-service/src:/app/src:ro
      - ../shared:/app/shared:ro
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
      - fiserv_api_key
      - fiserv_api_secret
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8015/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nemo_remote_network

  # ============================================================================
  # N8N Integration Service - CPU Only
  # ============================================================================

  n8n-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.n8n
    container_name: nemo_remote_n8n
    restart: unless-stopped
    environment:
      VOICE_MONKEY_TOKEN_FILE: /run/secrets/voicemonkey_token
      N8N_WEBHOOK_URL: "${N8N_WEBHOOK_URL:-}"
      JWT_ONLY: "true"
    volumes:
      - ../services/n8n-service/src:/app/src:ro
      - ../shared:/app/shared:ro
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
      - voicemonkey_token
    ports:
      - "127.0.0.1:8011:8011"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8011/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nemo_remote_network

# Secrets (same as main compose)
secrets:
  jwt_secret_primary:
    file: ./secrets/jwt_secret_primary
  jwt_secret_previous:
    file: ./secrets/jwt_secret_previous
  jwt_secret:
    file: ./secrets/jwt_secret
  session_key:
    file: ./secrets/session_key
  postgres_user:
    file: ./secrets/postgres_user
  postgres_password:
    file: ./secrets/postgres_password
  users_db_key:
    file: ./secrets/users_db_key
  rag_db_key:
    file: ./secrets/rag_db_key
  redis_password:
    file: ./secrets/redis_password
  email_db_key:
    file: ./secrets/email_db_key
  voicemonkey_token:
    file: ./secrets/voicemonkey_token
  fiserv_api_key:
    file: ./secrets/fiserv_api_key
  fiserv_api_secret:
    file: ./secrets/fiserv_api_secret

networks:
  nemo_remote_network:
    driver: bridge

volumes:
  redis_data:
  postgres_data:
  ml_uploads:
