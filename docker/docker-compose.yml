services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================
  
  redis:
    image: redis:7-alpine
    container_name: refactored_redis
    restart: unless-stopped
    # Phase 7: Bind to loopback only for dev (or remove ports entirely for prod)
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - nemo_network

  postgres:
    image: postgres:15-alpine
    container_name: refactored_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: nemo_queue
      # Phase 5: Use secrets for credentials
      POSTGRES_USER_FILE: /run/secrets/postgres_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    # Phase 7: Bind to loopback only for dev (or remove ports entirely for prod)
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    secrets:
      - postgres_user
      - postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$(cat /run/secrets/postgres_user)"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - nemo_network

  # ============================================================================
  # GPU Coordinator Service
  # ============================================================================
  
  gpu-coordinator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.queue
    container_name: refactored_gpu_coordinator
    restart: unless-stopped
    environment:
      REDIS_URL: redis://redis:6379
      # Use secret for Postgres password via connection string
      GPU_PAUSE_TIMEOUT: "12.0"
      JWT_ONLY: "true"
    # Phase 4: Remove host port mapping - internal only
    # ports:
    #   - "8002:8002"
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "from urllib.request import urlopen; urlopen('http://localhost:8002/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nemo_network

  # ============================================================================
  # Gemma Service (GPU Requester)
  # ============================================================================
  
  gemma-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gemma
    container_name: refactored_gemma
    restart: unless-stopped
    environment:
      GEMMA_MODEL_PATH: /app/models/gemma-3-4b-it-UD-Q4_K_XL.gguf  # 4-bit model (2.4GB) - Production
      GEMMA_GPU_LAYERS: "-1"  # ALL layers on GPU
      GEMMA_CONTEXT_SIZE: "2048"  # 2k context (saves RAM)
      GEMMA_BATCH_SIZE: "512"  # Smaller batch to save RAM
      GPU_COORDINATOR_URL: http://gpu-coordinator:8002
      RAG_SERVICE_URL: http://rag-service:8004
      JWT_ONLY: "true"
    volumes:
      - ../models:/app/models:ro
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    # Phase 4: Remove host port mapping - internal only
    # ports:
    #   - "8001:8001"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      gpu-coordinator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - nemo_network

  # ============================================================================
  # Transcription Service (GPU Owner)
  # ============================================================================
  
  transcription-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.transcription
    container_name: refactored_transcription
    restart: unless-stopped
    environment:
      REDIS_URL: redis://redis:6379
      EMOTION_SERVICE_URL: http://emotion-service:8005
      RAG_SERVICE_URL: http://rag-service:8004
      # Parakeet-TDT + Pyannote Diarization Strategy
      TRANSCRIBE_STRATEGY: "parakeet"
      PARAKEET_MODEL_ID: "nvidia/parakeet-tdt-0.6b-v2"
      PARAKEET_CHUNK_DURATION: "300"
      ENABLE_PYANNOTE: "true"
      PYANNOTE_DEVICE: "cuda"
      DIARIZER_BACKEND: "nemo"
      SORTFORMER_MODEL: /app/models/diar_sortformer_4spk-v1.nemo
      SORTFORMER_MAX_SPKS: "4"
      SORTFORMER_DEVICE: "cuda"
      DIARIZATION_SPK_MAX: "4"
      CUDA_LAUNCH_BLOCKING: "1"
      TORCH_USE_CUDA_DSA: "1"
      PYTORCH_CUDA_ALLOC_CONF: "max_split_size_mb:64"
      # PYANNOTE_MAX_SPEAKERS: "2"  # Uncomment to force specific number of speakers
      # Legacy RNNT settings (kept for fallback)
      NEMO_MODEL_NAME: "nvidia/parakeet-rnnt-0.6b"
      HF_HOME: /app/models  # HuggingFace cache directory in image
      JWT_ONLY: "true"
    volumes:
      - ../models/diar_sortformer_4spk-v1.nemo:/app/models/diar_sortformer_4spk-v1.nemo:ro
      - ../services/transcription-service/src:/app/src
      - ../shared:/app/shared
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
      - huggingface_token
    # Models are pre-downloaded in Docker image during build
    # Phase 4: Remove host port mapping - internal only
    # ports:
    #   - "8003:8003"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      redis:
        condition: service_healthy
      gpu-coordinator:
        condition: service_healthy
      gemma-service:
        condition: service_healthy  # WAIT for Gemma to load on GPU first!
    healthcheck:
      test: ["CMD", "python", "-c", "from urllib.request import urlopen; urlopen('http://localhost:8003/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nemo_network

  # ============================================================================
  # API Gateway (Frontend & Authentication)
  # ============================================================================
  
  api-gateway:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gateway
    image: refactored-gateway:latest
    container_name: refactored_gateway
    restart: unless-stopped
    environment:
      GEMMA_URL: http://gemma-service:8001
      RAG_URL: http://rag-service:8004
      EMOTION_URL: http://emotion-service:8005
      TRANSCRIPTION_URL: http://transcription-service:8003
      INSIGHTS_URL: http://insights-service:8010
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_DEFAULT: "1000"
      RATE_LIMIT_WINDOW_SEC: "60"
      ENABLE_DEMO_USERS: "true"
      ALLOWED_ORIGINS: "http://127.0.0.1,http://localhost"
      SESSION_COOKIE_SECURE: "false"
      SESSION_COOKIE_SAMESITE: "lax"
      # Disable canonical host redirects in dev to avoid host/IP mismatches
      CANONICAL_HOST: ""
      # Relax login rate limiting for local dev (still enforced, just higher thresholds)
      LOGIN_RATE_LIMIT_WINDOW: "60"
      LOGIN_RATE_LIMIT_LIMIT: "1000"
    volumes:
      - ./gateway_instance:/app/instance
      # Mount local frontend for live UI updates in dev (read-only)
      - ../frontend:/app/frontend:ro
      # Mount gateway source + shared modules for hot reload
      - ../services/api-gateway/src:/app/src:ro
      - ../shared:/app/shared:ro
    secrets:
      - session_key
      - users_db_key
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Phase 1: Gateway is the only public-facing service
    # For production, bind to 127.0.0.1 and use tunnel/reverse proxy
    ports:
      - "0.0.0.0:8000:8000"
    # Secrets are mounted via a read-only bind to ./secrets for dev
    depends_on:
      gemma-service:
        condition: service_healthy
      rag-service:
        condition: service_healthy
      emotion-service:
        condition: service_healthy
      transcription-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nemo_network
  
  # ============================================================================
  # RAG Service (Memory & Vector Search)
  # ============================================================================
  
  rag-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.rag
    image: refactored-rag-service:latest
    container_name: refactored_rag
    restart: unless-stopped
    environment:
      EMBEDDING_MODEL: "sentence-transformers/all-MiniLM-L6-v2"
      DB_PATH: "/app/instance/rag.db"
      FAISS_INDEX_PATH: "/app/faiss_index/index.bin"
      HF_HOME: "/app/models"
      JWT_ONLY: "true"
      EMAIL_ANALYZER_ENABLED: "true"
      EMAIL_DB_ENCRYPTION: "true"
      EMAIL_DB_KEY_FILE: /run/secrets/email_db_key
      EMAIL_DB_PATH: /app/instance/email.db
    volumes:
      - ./rag_instance:/app/instance
      - ./faiss_index:/app/faiss_index
      - ../models:/app/models
      - ../shared:/app/shared
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
      - rag_db_key
      - email_db_key
    # Phase 4: Remove host port mapping - internal only
    # ports:
    #   - "8004:8004"
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - nemo_network

  # ============================================================================
  # Insights / Analytics Service
  # ============================================================================

  insights-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.insights
    container_name: refactored_insights
    restart: unless-stopped
    environment:
      INSIGHTS_DB_PATH: /app/instance/rag.db
    volumes:
      - ./rag_instance:/app/instance
      - ../shared:/app/shared
    secrets:
      - rag_db_key
    depends_on:
      rag-service:
        condition: service_healthy
    networks:
      - nemo_network
  
  # ============================================================================
  # Emotion Service (Sentiment Analysis)
  # ============================================================================
  
  emotion-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile.emotion
    image: refactored-emotion-service:latest
    container_name: refactored_emotion
    restart: unless-stopped
    environment:
      EMOTION_MODEL_PATH: "/app/models/emotion-english-distilroberta-base"
      JWT_ONLY: "true"
    volumes:
      - ../models:/app/models:ro
    secrets:
      - jwt_secret_primary
      - jwt_secret_previous
      - jwt_secret
    # Phase 4: Remove host port mapping - internal only
    # ports:
    #   - "8005:8005"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; r = requests.get('http://localhost:8005/health'); exit(0 if r.json().get('status') == 'healthy' and r.json().get('classifier_loaded') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - nemo_network

# Phase 5: Define Docker secrets (read from files in docker/secrets/)
secrets:
  jwt_secret_primary:
    file: ./secrets/jwt_secret_primary
  jwt_secret_previous:
    file: ./secrets/jwt_secret_previous
  jwt_secret:
    file: ./secrets/jwt_secret
  service_api_key:
    file: ./secrets/service_api_key
  session_key:
    file: ./secrets/session_key
  postgres_user:
    file: ./secrets/postgres_user
  postgres_password:
    file: ./secrets/postgres_password
  users_db_key:
    file: ./secrets/users_db_key
  rag_db_key:
    file: ./secrets/rag_db_key
  redis_password:
    file: ./secrets/redis_password
  huggingface_token:
    file: ./secrets/huggingface_token
  email_db_key:
    file: ./secrets/email_db_key

networks:
  nemo_network:
    driver: bridge

volumes:
  redis_data:
  postgres_data:
